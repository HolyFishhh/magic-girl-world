<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>魔法少女RPG</title><style>@import url(https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@300;400;500&display=swap);
/*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */:root{--notebook-bg:#fffaf7;--notebook-border:#f2e4d5;--text-primary:#6d5b5b;--text-secondary:#b19d9d;--bookmark-pink:#ffd9e2;--bookmark-blue:#d4eaff;--bookmark-green:#d8f5d8;--bookmark-purple:#e9e0ff;--bookmark-yellow:#fff9c4;--bookmark-active-shadow:0 4px 12px rgba(136,98,98,0.15);--transition:all 0.35s cubic-bezier(0.4,0,0.2,1);--body-bg:#f8f3ed;--body-bg-pattern:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e8e0d4' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");--option-btn-bg:var(--bookmark-blue);--option-btn-hover:var(--bookmark-purple);--card-bg:white;--info-card-bg:rgba(255,255,255,0.6);--reward-card-bg:var(--notebook-bg);--pane-bg:#fff;--pane-change-bg:#fffef6;--pane-exp-bg:#f0f8ff;--highlight-quote:#5a7fa3;--highlight-book:#6b8e7d;--highlight-bracket:#b8934a;--highlight-paren:#9c7ba8;--highlight-emphasis:#c27864}[data-theme=dark]{--notebook-bg:#2b2b2b;--notebook-border:#444;--text-primary:#ededed;--text-secondary:#c4c4c4;--bookmark-pink:#6b4155;--bookmark-blue:#3d5266;--bookmark-green:#3d5547;--bookmark-purple:#4a4066;--bookmark-yellow:#6b6347;--bookmark-active-shadow:0 4px 12px rgba(0,0,0,0.5);--body-bg:#1a1a1a;--body-bg-pattern:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23333333' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");--option-btn-bg:#3d5266;--option-btn-hover:#4a4066;--card-bg:#333;--info-card-bg:rgba(50,50,50,0.8);--reward-card-bg:#2b2b2b;--pane-bg:#333;--pane-change-bg:#3a3a2f;--pane-exp-bg:#2d3a4a;--highlight-quote:#8eb4d4;--highlight-book:#9bc4ab;--highlight-bracket:#d4b87a;--highlight-paren:#c4a8d4;--highlight-emphasis:#d4a294}*{box-sizing:border-box;margin:0;padding:0}body{font-family:"Noto Sans SC",sans-serif;line-height:1.7;color:var(--text-primary);background-color:var(--body-bg);background-image:var(--body-bg-pattern);overflow-x:hidden;padding:20px;transition:background-color .3s ease,color .3s ease}.rpg-container{max-width:900px;margin:2rem auto;position:relative;font-family:"Microsoft YaHei","Segoe UI","Helvetica Neue",sans-serif;width:100%;aspect-ratio:9/14}@media (max-width:768px){.rpg-container{aspect-ratio:auto}}.rpg-container .notebook-body{background:var(--notebook-bg);border:1px solid var(--notebook-border);border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:2rem;padding-top:5rem;position:relative}.reward-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3);z-index:1000;display:flex;align-items:flex-start;justify-content:center;padding:20px}.reward-card{background:var(--reward-card-bg);border:2px solid var(--notebook-border);border-radius:8px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);width:100%;max-width:100%}.reward-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}.reward-header .title{font:800 18px "ZCOOL KuaiLe","Noto Sans SC",system-ui;color:var(--text-primary)}.reward-header .badge{margin-left:auto;padding:4px 10px;border-radius:10px;border:2px solid var(--notebook-border);background:var(--bookmark-yellow);color:var(--text-primary);font:900 12px "ZCOOL KuaiLe","Noto Sans SC"}.reward-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-bottom:12px;width:100%}.pane{border-radius:8px;padding:10px;background:var(--pane-bg);border:2px dashed #d9c7aa}.pane.pane-change{background:var(--pane-change-bg);grid-column:1/-1}.pane.pane-exp{background:var(--pane-exp-bg);border-color:skyblue;grid-column:1/-1}.pane.pane-card{border-color:#ffc1d6}.pane.pane-artifact{border-color:#b9d6ff}.pane.pane-item{border-color:#bfe7bf}.pane-tag{display:inline-block;padding:2px 10px;border-radius:8px;border:2px solid #d9c7aa;background:#fff;color:#6b5b2e;font:800 12px "ZCOOL KuaiLe","Noto Sans SC"}.change-list{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;color:#6b5b2e;font:500 13px "Noto Sans SC"}.pill{padding:6px 10px;border-radius:8px;background:#fffef6;border:2px dashed #d9c7aa}.exp-display{margin-top:8px;display:flex;flex-direction:column;gap:8px;color:#2c5aa0;font:500 13px "Noto Sans SC"}.exp-item{padding:8px 12px;border-radius:8px;background:#e6f3ff;border:2px solid skyblue;display:flex;align-items:center;gap:8px}.exp-icon{font-size:16px}.exp-text{flex:1;font-weight:600}.pane-head{display:flex;align-items:center;margin-bottom:8px}.pane-title{font:800 14px "ZCOOL KuaiLe","Noto Sans SC";color:var(--text-primary)}.pane-sub{margin-left:auto;color:var(--text-secondary);font:700 12px "Noto Sans SC"}.option{margin-top:8px;display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;background:#fffef6;border:2px dashed currentColor;cursor:pointer}.pane-card .option{color:#a66a79;background:#fffef9;border-color:#ffc1d6}.pane-artifact .option{color:#5c6b82;background:#f8fbff;border-color:#b9d6ff}.pane-item .option{color:#5b7a5b;background:#f7fff7;border-color:#bfe7bf}.option .icon{font-size:18px}.option .text{flex:1;min-width:0}.option .name{font:800 13px "ZCOOL KuaiLe","Noto Sans SC";color:var(--text-primary);word-break:break-word}.option .cost{font:600 11px "Noto Sans SC";color:var(--bookmark-blue);margin-bottom:2px;word-break:break-word}.option .desc{font:700 12px "Noto Sans SC";color:var(--text-secondary);word-break:break-word}.reward-actions{display:flex;gap:8px;justify-content:flex-end}.btn{padding:8px 12px;border-radius:8px;font:800 12px "ZCOOL KuaiLe","Noto Sans SC";border:2px solid var(--notebook-border);background:#fff;color:var(--text-primary);cursor:pointer;transition:var(--transition)}.btn.btn-primary{border:0;color:#634d4d;background:linear-gradient(180deg,var(--bookmark-yellow),#ffd9e2);box-shadow:0 8px 16px rgba(136,98,98,.12),inset 0 0 0 2px var(--notebook-border)}.btn.btn-primary:disabled{opacity:.5;cursor:not-allowed}.btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.1)}.tab-navigation{position:absolute;top:1.5rem;left:2rem;right:2rem;display:flex;justify-content:flex-start;align-items:flex-end;z-index:10;height:50px}.tab-navigation .tab-button{background:var(--bookmark-pink);border:1px solid var(--notebook-border);border-bottom:none;border-radius:12px 12px 4px 4px;padding:.8rem 1.3rem;cursor:pointer;color:var(--text-primary);font-family:"ZCOOL KuaiLe",cursive;font-size:1.1rem;margin-right:5px;transition:var(--transition);box-shadow:0 -1px 4px rgba(0,0,0,.04) inset;position:relative;transform-origin:bottom center}.tab-navigation .tab-button:nth-child(1){transform:rotate(-2deg)}.tab-navigation .tab-button:nth-child(2){background-color:var(--bookmark-blue);transform:rotate(1.5deg)}.tab-navigation .tab-button:nth-child(3){background-color:var(--bookmark-green);transform:rotate(-1deg)}.tab-navigation .tab-button:nth-child(4){background-color:var(--bookmark-purple);transform:rotate(2.5deg)}.tab-navigation .tab-button:nth-child(5){background-color:var(--bookmark-yellow);transform:rotate(-1.5deg)}.tab-navigation .tab-button:hover{transform:translateY(-5px) rotate(0)}.tab-navigation .tab-button.active{transform:translateY(-10px) rotate(0);box-shadow:var(--bookmark-active-shadow);z-index:5}.tab-navigation .tab-button.active::after{content:"";position:absolute;top:5px;right:5px;width:14px;height:14px;background:radial-gradient(circle,#ff8a8a 0%,#e53935 100%);border:1px solid rgba(0,0,0,.2);border-radius:50%;box-shadow:1px 1px 3px rgba(0,0,0,.2)}.tab-navigation .tab-button .tab-icon{margin-right:.5rem}.tab-navigation .tab-button:nth-child(2).active::after{background:radial-gradient(circle,#8dc8ff 0%,#3a8ee5 100%)}.tab-navigation .tab-button:nth-child(3).active::after{background:radial-gradient(circle,#83e083 0%,#36a536 100%)}.tab-navigation .tab-button:nth-child(4).active::after{background:radial-gradient(circle,#c0a8ff 0%,#8b6ce5 100%)}.tab-navigation .tab-button:nth-child(5).active::after{background:radial-gradient(circle,#ffe68a 0%,#e5b839 100%)}.tab-content .module-content{display:none;animation:fadeIn .5s ease-in-out}.tab-content .module-content[style*="display: block"]{display:block !important}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.section{margin-bottom:2.5rem}.section:last-child{margin-bottom:0}.section-title{font-size:2rem;font-weight:normal;font-family:"ZCOOL KuaiLe",cursive;color:var(--text-primary);margin-bottom:1.5rem;padding-bottom:.75rem;border-bottom:3px dotted var(--notebook-border)}.story-text{font-family:"Noto Sans SC",sans-serif;font-size:1.15rem;line-height:1.8;color:var(--text-primary);margin-bottom:1.5rem;white-space:pre-wrap}.story-text p{margin-bottom:1rem}.story-text p:last-child{margin-bottom:0}.story-text strong{color:#8b4c98;font-weight:500}.story-text em{color:var(--text-secondary);font-style:italic}.story-text .highlight-quote{color:var(--highlight-quote);font-weight:500}.story-text .highlight-book{color:var(--highlight-book);font-weight:500}.story-text .highlight-bracket{color:var(--highlight-bracket);font-weight:500}.story-text .highlight-paren{color:var(--highlight-paren);font-style:normal}.story-text .highlight-emphasis{color:var(--highlight-emphasis);font-weight:600}.card-description .highlight-quote,.desc .highlight-quote,.status-description .highlight-quote,.info-item .value .highlight-quote,.item-description .highlight-quote{color:var(--highlight-quote);font-weight:500}.card-description .highlight-book,.desc .highlight-book,.status-description .highlight-book,.info-item .value .highlight-book,.item-description .highlight-book{color:var(--highlight-book);font-weight:500}.card-description .highlight-bracket,.desc .highlight-bracket,.status-description .highlight-bracket,.info-item .value .highlight-bracket,.item-description .highlight-bracket{color:var(--highlight-bracket);font-weight:500}.card-description .highlight-paren,.desc .highlight-paren,.status-description .highlight-paren,.info-item .value .highlight-paren,.item-description .highlight-paren{color:var(--highlight-paren)}.card-description .highlight-emphasis,.desc .highlight-emphasis,.status-description .highlight-emphasis,.info-item .value .highlight-emphasis,.item-description .highlight-emphasis{color:var(--highlight-emphasis);font-weight:600}.story-options{display:flex;flex-direction:column;gap:.75rem;margin-top:1rem}.story-options p{margin-bottom:.5rem;font-family:"ZCOOL KuaiLe",cursive;font-size:1.2rem;color:var(--text-primary)}.story-options ol{padding-left:0;list-style:none}.story-options ol li{background:hsla(0,0%,100%,.5);border:1px solid var(--notebook-border);border-radius:8px;padding:1rem;margin-bottom:.5rem;position:relative;font-family:"ZCOOL KuaiLe",cursive;font-size:1.1rem;line-height:1.6;transition:var(--transition)}.story-options ol li:hover{background:rgba(214,182,182,.15);transform:translateX(5px)}.story-options ol li::before{content:counter(list-item) "️⃣";counter-increment:list-item;position:absolute;left:-2rem;top:50%;transform:translateY(-50%);font-size:1.2rem}.data-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin-bottom:1.5rem}.info-card{border:none;border-radius:8px;padding:1.25rem;background:var(--info-card-bg);box-shadow:0 4px 15px rgba(136,98,98,.08);transition:var(--transition)}.info-card:hover{box-shadow:0 6px 20px rgba(136,98,98,.12);transform:translateY(-2px)}.info-card .card-title{font-weight:normal;font-family:"ZCOOL KuaiLe",cursive;font-size:1.4rem;margin-bottom:.75rem;color:#8b4c98;border-bottom:2px dotted var(--notebook-border);padding-bottom:.5rem}.info-card .info-item{display:flex;justify-content:space-between;align-items:flex-start;padding:.6rem 0;border-top:1px dashed var(--notebook-border);font-family:"ZCOOL KuaiLe",cursive;font-size:1rem}.info-card .info-item:first-of-type{border-top:none}.info-card .info-item .label{color:var(--text-secondary);font-weight:400;white-space:nowrap;margin-right:1rem}.info-card .info-item .value{font-weight:500;color:var(--text-primary);text-align:right;word-break:break-word;line-height:1.4}.battle-deck{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem}.card,.battle-card-item{border:1px solid var(--notebook-border);padding:1rem;border-radius:8px;text-align:center;background:var(--card-bg);font-family:"ZCOOL KuaiLe",cursive;font-size:1rem;transition:var(--transition);box-shadow:0 2px 8px rgba(0,0,0,.05)}.card:hover,.battle-card-item:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,.1)}.card .card-name,.battle-card-item .card-name{font-weight:600;font-size:1.1rem;margin-bottom:.5rem;color:#8b4c98}.card .card-name .card-quantity,.battle-card-item .card-name .card-quantity{color:var(--text-secondary);font-size:.9rem;margin-left:.5rem}.card .card-cost,.battle-card-item .card-cost{color:var(--bookmark-blue);margin-bottom:.5rem;font-weight:500}.card .card-description,.battle-card-item .card-description{color:var(--text-secondary);font-size:.9rem;line-height:1.4}.delete-control-card{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:120px;background:linear-gradient(135deg,#ffebee,#fce4ec);border:2px dashed #f44}.delete-control-card .delete-mode-btn{background:#f44;color:#fff;border:none;width:50px;height:50px;border-radius:50%;font-size:1.5rem;cursor:pointer;transition:all .2s ease;box-shadow:0 2px 6px rgba(0,0,0,.2);margin-bottom:.5rem}.delete-control-card .delete-mode-btn:hover{background:#f66;transform:scale(1.1);box-shadow:0 4px 10px rgba(0,0,0,.3)}.delete-control-card .delete-mode-btn.delete-mode-active{background:#c33;animation:pulse 1.5s infinite}.delete-control-card .delete-mode-btn.delete-mode-active:hover{background:#d44}.delete-control-card .delete-count{font-size:.8rem;color:#666;text-align:center}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}.card,.battle-card-item{position:relative}.card .card-delete-overlay,.battle-card-item .card-delete-overlay{position:absolute;top:-5px;right:-5px;width:30px;height:30px;background:#f44;border:2px solid #fff;border-radius:50%;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:all .2s ease;box-shadow:0 2px 6px rgba(0,0,0,.3)}.card .card-delete-overlay .delete-icon,.battle-card-item .card-delete-overlay .delete-icon{font-size:.8rem;color:#fff}.card .card-delete-overlay:hover,.battle-card-item .card-delete-overlay:hover{background:#f66;transform:scale(1.1);box-shadow:0 3px 8px rgba(0,0,0,.4)}.battle-deck.delete-mode .card .card-delete-overlay,.battle-deck.delete-mode .battle-card-item .card-delete-overlay{display:flex}.battle-deck.delete-mode .card:hover,.battle-deck.delete-mode .battle-card-item:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,68,68,.3)}.item-use-btn{background:#4a4;color:#fff;border:2px solid #393;padding:.4rem .8rem;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer;margin-top:.5rem;transition:all .2s ease;box-shadow:0 2px 4px rgba(0,0,0,.1)}.item-use-btn:hover{background:#6c6;border-color:#4a4;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.2)}.item-use-btn:active{transform:translateY(0);box-shadow:0 2px 4px rgba(0,0,0,.1)}.tracking-btn{border:2px solid;padding:.3rem .6rem;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;margin-left:.5rem;transition:all .2s ease;box-shadow:0 2px 4px rgba(0,0,0,.1)}.tracking-btn.tracking-on{background:#f44;color:#fff;border-color:#c33}.tracking-btn.tracking-on:hover{background:#f66;border-color:#f44;transform:translateY(-1px);box-shadow:0 3px 6px rgba(0,0,0,.15)}.tracking-btn.tracking-off{background:#4a4;color:#fff;border-color:#393}.tracking-btn.tracking-off:hover{background:#6c6;border-color:#4a4;transform:translateY(-1px);box-shadow:0 3px 6px rgba(0,0,0,.15)}.tracking-btn:active{transform:translateY(0);box-shadow:0 2px 4px rgba(0,0,0,.1)}.debug-panel{margin-top:2rem;padding:1.25rem;background:rgba(0,0,0,0);border:2px dashed var(--notebook-border);border-radius:8px}.debug-panel h4{text-align:center;margin-bottom:1rem;color:var(--text-secondary);font-size:1.1rem;font-family:"ZCOOL KuaiLe",cursive}.debug-panel .debug-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.75rem}.debug-panel .debug-buttons .debug-btn{background:rgba(0,0,0,.03);border:1px solid var(--notebook-border);color:var(--text-secondary);padding:.75rem 1rem;border-radius:6px;cursor:pointer;font-family:"ZCOOL KuaiLe",cursive;font-size:1rem;transition:var(--transition)}.debug-panel .debug-buttons .debug-btn:hover{background:rgba(0,0,0,.06);color:var(--text-primary);transform:translateY(-1px)}.debug-panel .debug-buttons .debug-btn:active{transform:translateY(0)}.theme-toggle{position:fixed;top:20px;right:20px;width:50px;height:50px;border-radius:50%;border:2px solid var(--notebook-border);background:var(--notebook-bg);color:var(--text-primary);cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:var(--transition);z-index:1000;display:flex;align-items:center;justify-content:center;font-size:24px}.theme-toggle:hover{transform:scale(1.1) rotate(15deg);box-shadow:0 6px 16px rgba(0,0,0,.25)}.theme-toggle:active{transform:scale(0.95)}.theme-toggle .theme-icon{display:block;transition:transform .3s ease}@media (max-width:768px){.status-tag{font-size:12px;padding:5px 10px;margin:3px 4px 3px 0}.status-detail{font-size:12px;padding:10px 12px}.status-label{font-size:13px}.theme-toggle{top:10px;right:10px;width:40px;height:40px;font-size:20px}}@media (max-width:768px){body{background-image:none;padding:10px;font-size:16px}.rpg-container{margin:0;width:100%;display:flex;flex-direction:column}.rpg-container .notebook-body{border-radius:0;box-shadow:none;overflow-y:auto;padding:1rem;padding-top:4.5rem;-webkit-overflow-scrolling:touch}.rpg-container .debug-panel{flex-shrink:0;border-radius:0;margin-top:0;border-top:2px dashed var(--notebook-border)}.tab-navigation{left:1rem;right:1rem;height:40px;padding-right:50px}.tab-navigation .tab-button{padding:.6rem .6rem;font-size:.9rem;transform:rotate(0) !important;margin-right:-5px;min-width:44px;min-height:44px}.tab-navigation .tab-button.active{transform:translateY(-5px) !important}.tab-navigation .tab-button.active::after{width:10px;height:10px;top:4px;right:4px}.tab-navigation .tab-button .tab-icon{margin-right:.3rem}}@media (max-width:768px)and (max-width:480px){.tab-navigation .tab-button{font-size:0;padding:.5rem}.tab-navigation .tab-button .tab-icon{margin-right:0;font-size:1.2rem}}@media (max-width:768px){.section-title{font-size:1.6rem;margin-bottom:1rem}.data-grid{grid-template-columns:1fr;gap:1rem}.story-text{font-size:1rem;line-height:1.6}.story-options ol li{font-size:.95rem;padding:.8rem}.story-options ol li::before{left:-1.5rem;font-size:1rem}input[type=text],.custom-action input{font-size:16px !important}.battle-deck{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.75rem}.card,.battle-card-item{font-size:.9rem;padding:.75rem}.info-card{padding:1rem}.info-card .info-item{padding:.5rem 0;flex-direction:column;align-items:flex-start}.info-card .info-item .label{margin-bottom:.25rem;margin-right:0}.info-card .info-item .value{text-align:left}.reward-card{padding:12px}.reward-grid{grid-template-columns:1fr;gap:10px}.option{padding:10px;font-size:.9rem}.option .icon{font-size:20px}.option .name{font-size:12px}.option .desc{font-size:11px}}@media (max-width:480px){body{padding:5px}.rpg-container .notebook-body{padding:.75rem;padding-top:4rem}.section-title{font-size:1.4rem}.info-card h3{font-size:1.1rem}}@media (max-width:768px)and (orientation:landscape){.rpg-container .notebook-body{padding-top:3.5rem}.tab-navigation{height:35px}.tab-navigation .tab-button{padding:.4rem .5rem;font-size:.85rem}}.rpg-container::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(0deg,transparent,transparent 24px,rgba(0,0,0,0.02) 25px);pointer-events:none;border-radius:8px}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--notebook-bg)}::-webkit-scrollbar-thumb{background:var(--notebook-border);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:var(--text-secondary)}.option-btn{display:inline-block;margin:.3rem .4rem .3rem 0;padding:.5rem 1rem;border:1px solid var(--notebook-border);border-radius:6px;background:var(--option-btn-bg);font-family:"ZCOOL KuaiLe",cursive;cursor:pointer;transition:var(--transition);color:var(--text-primary);min-height:44px;display:inline-flex;align-items:center;justify-content:center}.option-btn:disabled,.option-btn.disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.option-btn:hover{background:var(--option-btn-hover);transform:translateY(-2px)}@media (hover:none)and (pointer:coarse){.option-btn:active{background:var(--option-btn-hover);transform:scale(0.98)}}.alignment-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:1rem}.alignment-cell{border:1px solid var(--notebook-border);padding:.5rem;text-align:center;font-size:.9rem;background:#fdf9f2;border-radius:4px;color:var(--text-primary);transition:var(--transition)}.alignment-cell.active{background:var(--bookmark-green);font-weight:bold;color:#1a3b1a;box-shadow:0 0 6px rgba(0,0,0,.15)}.faction-status{padding:.2rem .5rem;border-radius:4px;font-size:.9rem;font-weight:500}.faction-status.友好,.faction-status.friendly{background:var(--bookmark-green);color:#2e7d32}.faction-status.敌对,.faction-status.hostile{background:#ffebee;color:#c62828}.faction-status.中立,.faction-status.neutral{background:var(--bookmark-yellow);color:#f57c00}.faction-status.警惕,.faction-status.cautious{background:#fff3e0;color:#ef6c00}.faction-status.亦敌亦友,.faction-status.complicated{background:var(--bookmark-purple);color:#6a1b9a}.invasion-badge{display:inline-block;min-width:28px;text-align:center;font-weight:800}#invasion-intensity-row{margin-top:6px}.delete-toggle-btn{background:#ff6b6b;color:#fff;border:none;border-radius:6px;padding:4px 8px;margin-left:10px;cursor:pointer;font-size:14px;transition:var(--transition)}.delete-toggle-btn:hover{background:#ff5252;transform:scale(1.05)}.card,.battle-card-item{position:relative}.card .card-delete-btn,.battle-card-item .card-delete-btn{position:absolute;top:5px;right:5px;background:#ff6b6b;color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:12px;display:none;align-items:center;justify-content:center;transition:var(--transition)}.card .card-delete-btn:hover,.battle-card-item .card-delete-btn:hover{background:#ff5252;transform:scale(1.1)}.battle-deck.delete-mode .card,.battle-deck.delete-mode .battle-card-item{border:2px dashed #ff6b6b;background:rgba(255,107,107,.05)}.exp-test-btn{background:linear-gradient(135deg,#4caf50,#45a049);color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:14px;font-weight:500;transition:var(--transition);box-shadow:0 2px 4px rgba(76,175,80,.3)}.exp-test-btn:hover{background:linear-gradient(135deg,#45a049,#3d8b40);transform:translateY(-2px);box-shadow:0 4px 8px rgba(76,175,80,.4)}.exp-test-btn:active{transform:translateY(0);box-shadow:0 2px 4px rgba(76,175,80,.3)}.battle-option-btn{display:inline-block;margin:.3rem .4rem .3rem 0;padding:.5rem 1rem;border:1px solid var(--notebook-border);border-radius:6px;font-family:"ZCOOL KuaiLe",cursive;cursor:pointer;transition:var(--transition);background:#f44336;color:#fff}.battle-option-btn:disabled,.battle-option-btn.disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.battle-option-btn:hover{background:#d32f2f;transform:translateY(-2px)}.status-section{margin-bottom:16px}.status-section:last-child{margin-bottom:0}.status-label{font-size:14px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;font-family:"ZCOOL KuaiLe",cursive}.status-tags{display:flex;flex-wrap:wrap;gap:0;min-height:32px;align-items:flex-start}.status-tag{display:inline-block;padding:6px 12px;margin:4px 6px 4px 0;border-radius:16px;font-size:13px;font-weight:600;transition:var(--transition);border:2px solid rgba(0,0,0,0);line-height:1.4}.status-tag.status-permanent{background:linear-gradient(135deg,var(--bookmark-purple),#f3e5ff);color:#6a1b9a;border-color:#d4b3ff;box-shadow:0 2px 6px rgba(106,27,154,.15)}.status-tag.status-permanent.clickable{cursor:pointer}.status-tag.status-permanent.clickable:hover{background:linear-gradient(135deg,#dcc4ff,var(--bookmark-purple));transform:translateY(-2px);box-shadow:0 4px 10px rgba(106,27,154,.25)}.status-tag.status-permanent.clickable:active{transform:translateY(0)}.status-tag.status-permanent .expand-icon{font-size:10px;margin-left:4px;opacity:.7;transition:var(--transition)}.status-tag.status-temporary{background:linear-gradient(135deg,var(--bookmark-blue),#e3f2ff);color:#1565c0;border-color:#a3d5ff;box-shadow:0 2px 6px rgba(21,101,192,.15)}.status-tag.status-empty{background:rgba(0,0,0,0);color:var(--text-secondary);border-color:var(--notebook-border);border-style:dashed;box-shadow:none}.status-tag-wrapper{display:inline-block;margin:0}.status-detail{margin-top:8px;padding:12px 14px;background:hsla(0,0%,100%,.9);border:2px solid var(--bookmark-purple);border-radius:8px;color:var(--text-primary);font-size:13px;line-height:1.6;box-shadow:0 4px 12px rgba(106,27,154,.12);animation:slideDown .3s ease-out;max-width:100%;word-wrap:break-word}@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}.battle-book-container{display:flex;flex-direction:column;gap:12px}.battle-book-btn{background:linear-gradient(180deg,var(--bookmark-yellow),var(--bookmark-pink));color:var(--text-primary);border:2px solid var(--notebook-border);padding:12px 16px;border-radius:8px;font-size:14px;font-weight:800;cursor:pointer;transition:var(--transition);box-shadow:0 6px 14px rgba(136,98,98,.12)}.battle-book-btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(136,98,98,.16)}.battle-book-btn:active{transform:translateY(0)}.battle-book-content{background:hsla(0,0%,100%,.65);border-radius:8px;padding:16px;border:2px dashed var(--notebook-border);max-height:400px;overflow-y:auto;color:var(--text-primary)}.battle-book-section{margin-bottom:20px}.battle-book-section h4{color:var(--text-primary);font-size:16px;font-weight:800;margin-bottom:12px;padding-bottom:6px;border-bottom:2px dotted var(--notebook-border)}.status-effect-item{background:#fffef6;border-radius:6px;padding:12px;margin-bottom:8px;border:2px dashed var(--notebook-border)}.status-effect-item .status-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}.status-effect-item .status-header .status-icon{font-size:18px;min-width:24px;text-align:center}.status-effect-item .status-header .status-name{font-weight:800;color:var(--text-primary);font-size:14px}.status-effect-item .status-header .status-stacks{background:var(--bookmark-blue);color:var(--text-primary);padding:2px 8px;border-radius:4px;font-size:12px;font-weight:800;border:1px solid var(--notebook-border)}.status-effect-item .status-header .status-duration{color:var(--text-secondary);font-size:12px}.status-effect-item .status-header .status-type{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;border:1px dashed var(--notebook-border);background:var(--bookmark-yellow);color:var(--text-primary)}.status-effect-item .status-header .status-type.buff{background:var(--bookmark-green);color:#2e7d32}.status-effect-item .status-header .status-type.debuff{background:#ffebee;color:#c62828}.status-effect-item .status-description{color:var(--text-primary);font-size:13px;line-height:1.4;margin-bottom:4px}.status-effect-item .status-triggers{color:var(--text-secondary);font-size:11px;font-family:monospace;background:rgba(0,0,0,.04);padding:4px 6px;border-radius:4px;margin-top:6px;border:1px dashed var(--notebook-border)}[data-theme=dark] .alignment-cell{color:#f0f0f0;background:#2f2f2f;border-color:#555}[data-theme=dark] .alignment-cell.active{background:#356a35;color:#fff;box-shadow:0 0 8px rgba(0,0,0,.4)}
</style></head><body><div class="rpg-container"><button class="theme-toggle" id="theme-toggle" title="切换主题"><span class="theme-icon">🌙</span></button><nav class="tab-navigation"><button class="tab-button active" data-module="story"><span class="tab-icon">📖</span> 剧情</button> <button class="tab-button" data-module="status"><span class="tab-icon">✨</span> 状态栏</button> <button class="tab-button" data-module="battle"><span class="tab-icon">⚔️</span> 战斗</button> <button class="tab-button" data-module="npc"><span class="tab-icon">👭</span> NPC关系</button> <button class="tab-button" data-module="faction"><span class="tab-icon">🏰</span> 势力关系</button></nav><div class="notebook-body"><div class="tab-content"><div id="story-content" class="module-content" style="display:block"><div class="section"><h2 class="section-title">📖 当前剧情</h2><div class="story-text">$1</div></div><div class="section" id="notify-section" style="display:none"><div class="reward-card" id="notify-card"><div class="reward-header"><strong class="title">状态更新</strong> <span class="badge" id="level-exp-badge" style="display:none"></span></div><div class="reward-grid"><section class="pane pane-change" id="changes-section" style="display:none"><span class="pane-tag">本次变化</span><div class="change-list" id="changes-list"></div></section><section class="pane pane-exp" id="exp-section" style="display:none"><span class="pane-tag">等级与经验</span><div class="exp-display" id="exp-display"></div></section></div><div class="reward-actions"><button class="btn btn-plain" id="notify-dismiss-btn">知道了</button></div></div></div><div class="section"><h2 class="section-title">🎯 选项</h2><template id="options-template">$2</template><div class="options-text" data-source="options-template"></div><div class="custom-action" style="margin-top:10px;display:flex;gap:8px;align-items:center"><input id="custom-action-input" placeholder="输入你的自定义行动..." style="flex:1;padding:8px 10px;border:1px solid var(--notebook-border);border-radius:6px;background:#fffef6;color:var(--text-primary)"/> <button id="custom-action-send" class="option-btn" type="button">发送</button></div><div id="choice-container" style="display:none;margin-top:12px"><div class="reward-card" id="choice-card"><div class="reward-header"><strong class="title">奖励结算</strong></div><div class="reward-grid"><section class="pane pane-card" id="card-rewards-section" style="display:none"><div class="pane-head"><div class="pane-title">可选：卡牌 <span id="card-selection-count">3选1</span></div><div class="pane-sub">已选 <span id="card-selected">0</span>/<span id="card-max">1</span></div></div><div class="options" id="card-options"></div></section><section class="pane pane-artifact" id="artifact-rewards-section" style="display:none"><div class="pane-head"><div class="pane-title">可选：遗物 <span id="artifact-selection-count">3选1</span></div><div class="pane-sub">已选 <span id="artifact-selected">0</span>/<span id="artifact-max">1</span></div></div><div class="options" id="artifact-options"></div></section><section class="pane pane-item" id="item-rewards-section" style="display:none"><div class="pane-head"><div class="pane-title">可选：道具 <span id="item-selection-count">3选1</span></div><div class="pane-sub">已选 <span id="item-selected">0</span>/<span id="item-max">1</span></div></div><div class="options" id="item-options"></div></section></div><div class="reward-actions"><button class="btn btn-primary" id="confirm-btn" disabled="disabled">确认领取</button></div></div></div></div></div><div id="status-content" class="module-content"><div class="section"><h2 class="section-title">✨ 角色状态</h2><div class="data-grid"><div class="info-card"><h3>基本信息</h3><div class="info-item"><span class="label">时间:</span> <span class="value" id="status-time">未知</span></div><div class="info-item"><span class="label">地点:</span> <span class="value" id="status-location">未知</span></div><div class="info-item"><span class="label">职业:</span> <span class="value" id="status-job-name">未知</span></div><div class="info-item"><span class="label">职业能力:</span> <span class="value" id="status-job-ability">未知</span></div></div><div class="info-card"><h3>服装信息</h3><div class="info-item"><span class="label">头部:</span> <span class="value" id="clothing-head">未知</span></div><div class="info-item"><span class="label">颈部:</span> <span class="value" id="clothing-neck">未知</span></div><div class="info-item"><span class="label">手:</span> <span class="value" id="clothing-hands">未知</span></div><div class="info-item"><span class="label">上衣:</span> <span class="value" id="clothing-top">未知</span></div><div class="info-item"><span class="label">下衣:</span> <span class="value" id="clothing-bottom">未知</span></div><div class="info-item"><span class="label">内衣:</span> <span class="value" id="clothing-underwear">未知</span></div><div class="info-item"><span class="label">腿:</span> <span class="value" id="clothing-legs">未知</span></div><div class="info-item"><span class="label">脚:</span> <span class="value" id="clothing-feet">未知</span></div></div><div class="info-card"><h3>携带物品</h3><div class="data-grid" id="carried-items"></div></div><div class="info-card"><h3>状态效果</h3><div class="status-section"><div class="status-label">永久性状态:</div><div class="status-tags" id="permanent-status"><span class="status-tag status-empty">无</span></div></div><div class="status-section"><div class="status-label">临时状态:</div><div class="status-tags" id="temporary-status"><span class="status-tag status-empty">无</span></div></div></div></div></div></div><div id="battle-content" class="module-content"><div class="section"><h2 class="section-title">⚔️ 战斗信息</h2><div class="data-grid"><div class="info-card"><h3>核心属性</h3><div class="info-item"><span class="label">生命值:</span> <span class="value" id="battle-hp">未知</span></div><div class="info-item"><span class="label">欲望值:</span> <span class="value" id="battle-desire">未知</span></div><div class="info-item"><span class="label">等级:</span> <span class="value" id="battle-level">未知</span></div><div class="info-item"><span class="label">经验值:</span> <span class="value" id="battle-exp">未知</span></div><div class="info-item"><span class="label">卡牌删除次数:</span> <span class="value" id="battle-card-remove">未知</span></div></div><div class="info-card"><h3>战斗之书</h3><div class="battle-book-container"><button class="battle-book-btn" onclick="toggleBattleBook()">📖 查看状态效果</button><div class="battle-book-content" id="battle-book-content" style="display:none"></div></div></div><div class="info-card"><h3>遗物</h3><div class="data-grid" id="battle-artifacts"></div></div><div class="info-card"><h3>消耗品</h3><div class="data-grid" id="battle-items"></div></div><div class="info-card"><h3>卡牌组合 <button id="delete-mode-toggle" class="delete-toggle-btn" onclick="toggleDeleteMode()">🗑️<span id="delete-count">0</span></button></h3><div class="battle-deck" id="battle-deck"></div></div></div></div></div><div id="npc-content" class="module-content"><div class="section"><h2 class="section-title">👭 NPC关系</h2><div class="data-grid" id="npc-relations"></div></div></div><div id="faction-content" class="module-content"><div class="section"><h2 class="section-title">🏰 势力关系</h2><div class="alignment-grid" id="alignment-grid"></div><div class="data-grid"><div class="info-card"><div class="info-item" id="invasion-intensity-row"><span class="label">入侵强度:</span> <span class="value"><span id="invasion-intensity-badge" class="invasion-badge">未知</span></span></div></div></div><div class="data-grid" id="faction-relations"></div></div></div></div></div></div><script>const t=[{start:'“',end:'”',className:'highlight-quote'},{start:'"',end:'"',className:'highlight-quote'},{start:'‘',end:'’',className:'highlight-quote'},{start:'《',end:'》',className:'highlight-book'},{start:'【',end:'】',className:'highlight-bracket'},{start:'[',end:']',className:'highlight-bracket'},{start:'**',end:'**',className:'highlight-emphasis'}];function e(t,e){const n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:t=>{const n=t.parentNode||null;if(!n)return NodeFilter.FILTER_REJECT;if(['SCRIPT','STYLE','CODE','PRE'].includes(n.tagName))return NodeFilter.FILTER_REJECT;if(n.closest&&n.closest('.'+e.className))return NodeFilter.FILTER_REJECT;return(t.textContent||'').length<e.start.length+e.end.length+1?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}}),s=[];let o;for(;o=n.nextNode();)s.push(o);s.forEach((t=>{try{!function(t,e){let n=t;for(;n;){const t=n.textContent||'';if(!t||t.length<e.start.length+e.end.length+1)return;const s=t.indexOf(e.start);if(-1===s)return;let o=t.indexOf(e.end,s+e.start.length);if(-1===o)return;if('**'===e.start&&o===s+e.start.length&&(o=t.indexOf(e.end,o+e.end.length),-1===o))return;const a=n.parentNode;if(!a)return;const l=document.createTextNode(t.slice(0,s)),c=t.slice(s+e.start.length,o),i=document.createTextNode(t.slice(o+e.end.length)),r=document.createElement('span');r.className=e.className,r.textContent=c,a.insertBefore(l,n),a.insertBefore(document.createTextNode(e.start),n),a.insertBefore(r,n),a.insertBefore(document.createTextNode(e.end),n),a.insertBefore(i,n),a.removeChild(n),n=i}}(t,e)}catch{}}))}function n(){try{document.querySelectorAll('.story-text').forEach((n=>{if('true'!==n.getAttribute('data-highlighted'))try{t.forEach((t=>e(n,t))),n.setAttribute('data-highlighted','true')}catch(t){console.warn('处理元素失败:',t)}})),console.log('✅ 文本高亮已应用')}catch(t){console.error('文本高亮失败:',t)}}const s='rpg-ui-theme';function o(){const t=localStorage.getItem(s);return'dark'===t||'light'===t?t:window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'}function a(t){const e=document.documentElement,n=document.getElementById('theme-toggle'),o=n?.querySelector('.theme-icon');'dark'===t?(e.setAttribute('data-theme','dark'),o&&(o.textContent='☀️')):(e.removeAttribute('data-theme'),o&&(o.textContent='🌙')),localStorage.setItem(s,t)}function l(){a('light'===o()?'dark':'light')}if(window.matchMedia){window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',(t=>{localStorage.getItem(s)||a(t.matches?'dark':'light')}))}let c=null,i=null,r=null,d=null;function u(t){return t&&'object'==typeof t?t.stat_data&&'object'==typeof t.stat_data?t.stat_data:t:{}}let p=!1,m=[],f=!1;function g(){if(f)return;const t=document.getElementById('custom-action-input'),e=document.getElementById('custom-action-send');if(!t||!e)return;f=!0;const n=async()=>{const e=(t.value||'').trim();if(!e)return void('undefined'!=typeof toastr&&toastr.info('请输入要发送的内容'));const n=document.getElementById('choice-container');if(n&&'none'!==n.style.display)'undefined'!=typeof toastr&&toastr.warning('请先领取或跳过奖励');else if(!S)try{await q(e)}catch(t){console.error('自定义行动发送失败:',t),'undefined'!=typeof toastr&&toastr.error('发送失败，请重试')}finally{t.value='',t.focus()}};e.onclick=n,t.addEventListener('keydown',(t=>{'Enter'===t.key&&n()})),console.log('[自定义行动] 已绑定')}const y=[],h=[];!function(){const t=window;if(t.__AUGMENT_INJECT_WRAPPED)return;const e=e=>{const n=t[e];'function'==typeof n&&(t[e]=async e=>{const s=Array.isArray(e?.injects)?[...e.injects]:[];h.length&&s.push(...h.splice(0));const o=e&&'object'==typeof e?{...e,injects:s}:{injects:s};return await n.call(t,o)})};e('generate'),e('generateRaw'),t.__AUGMENT_INJECT_WRAPPED=!0}();const b={head:'头部',neck:'颈部',hands:'手部',upper_body:'上身',lower_body:'下身',underwear:'内衣',legs:'腿部',feet:'脚部',profession:'职业',inventory:'持有物',permanent_status:'永久状态'};function v(t){if(!t)return[];if(Array.isArray(t)){const e=[];return t.forEach(((t,n)=>{Array.isArray(t)?e.push(...C(t)):'$__META_EXTENSIBLE__$'!==t&&null!=t&&''!==t&&e.push(t)})),C(e)}return'object'==typeof t?[t]:[]}function E(t){const e=t?.reward;return e?Array.isArray(e)?e[0]:e:null}function x(t){const e=E(t);if(!e)return!1;const n=v(e.card),s=v(e.artifact),o=v(e.item);return n.length>0||s.length>0||o.length>0}function w(t,e){const n=[],s=t=>{try{return JSON.parse(t)}catch{return null}},o=t=>{if('string'!=typeof t)return null;if(!t.includes('->'))return null;console.log('🔍 解析箭头对:',t);const e=t.split('->');if(e.length<2)return null;const n=e[0].trim(),o=e.slice(1).join('->').trim();console.log('🔍 左侧:',n),console.log('🔍 右侧:',o);const a=s(n),l=s(o);return console.log('🔍 解析结果:',{oldVal:a,newVal:l}),{oldVal:a,newVal:l}},a=t?.status?.profession;if('string'==typeof a&&a.includes('->'))n.push('职业：'+a);else if(a&&'object'==typeof a){const t=a.name,e=a.ability;'string'==typeof t&&t.includes('->')&&n.push('职业名：'+t),'string'==typeof e&&e.includes('->')&&n.push('职业能力：'+e)}const l=t?.status?.clothing,c=['head','neck','hands','upper_body','lower_body','underwear','legs','feet'];if(console.log('🔍 服装 delta:',l),'string'==typeof l&&l.includes('->')&&l.includes('{')){const t=o(l);if(console.log('🔍 解析的服装对:',t),t&&t.newVal&&'object'==typeof t.newVal){const e=t.oldVal&&'object'==typeof t.oldVal?t.oldVal:{},s=t.newVal;c.forEach((t=>{const o=e?.[t]??'',a=s?.[t]??'';String(o)!==String(a)&&n.push(`${b[t]||t}：${o||'无'}->${a||'无'}`)}))}}else'object'==typeof l&&null!==l&&c.forEach((t=>{const e=l?.[t];'string'==typeof e&&e.includes('->')&&n.push(`${b[t]||t}：${e}`)}));const i=(t,e)=>{(Array.isArray(t)?t:'string'==typeof t?[t]:[]).forEach((t=>{const s=String(t),o=s.match(/ASSIGNED\s+"([^"]+)"/);o&&o[1]?n.push(`新增${e}：${o[1]}`):/新增|ADDED|\+/.test(s)&&n.push(`新增${e}：${s.replace(/^.*?(新增|ADDED|\+)\s*/,'')}`)}))};i(t?.status?.permanent_status,'永久状态'),i(t?.status?.inventory,'持有物');const r=(t,e)=>{if(!t)return;console.log(`🔍 ${e} delta:`,t);(Array.isArray(t)?t:'string'==typeof t?[t]:[]).forEach((t=>{const o=String(t);if(console.log(`🔍 ${e} 条目:`,o),o.includes('[')||o.includes('{')){const t=(t=>{if('string'!=typeof t)return null;const e=t.match(/ASSIGNED\s+(\[.*|\{.*)/),n=(t=>{const e=t.indexOf('[')>=0&&(-1===t.indexOf('{')||t.indexOf('[')<t.indexOf('{'))?'[':'{',n=t.indexOf(e);if(-1===n)return null;let s=0,o=!1,a=!1;for(let l=n;l<t.length;l++){const c=t[l];if(o){if(a){a=!1;continue}if('\\'===c){a=!0;continue}if('"'===c){o=!1;continue}}else if('"'!==c){if(c===e)s++;else if(c===('['===e?']':'}')&&(s--,0===s))return t.slice(n,l+1)}else o=!0}return null})(e?e[1]:t);if(!n)return null;const o=s(n);return Array.isArray(o)?o:o&&'object'==typeof o?[o]:null})(o);console.log(`🔍 ${e} 解析结果:`,t),t&&t.length&&t.forEach((t=>{const s=t?.name||t?.id||'未知',o=t?.quantity?` x${t.quantity}`:'';n.push(`新增${e}：${s}${o}`)}))}else o.includes('->')&&n.push(`${e}：${o}`)}))};r(t?.battle?.cards,'卡牌'),r(t?.battle?.artifacts,'遗物'),r(t?.battle?.items,'道具');const d=t?.battle?.player_lust_effect;if(d)if('string'==typeof d){if(d.includes('->')){const t=o(d),e=t&&t.newVal&&'object'==typeof t.newVal?t.newVal.name:null;e&&n.push(`玩家欲望效果：${e}`)}}else if('object'==typeof d&&null!==d){const t=d.name;if('string'==typeof t)if(t.includes('->')){const e=t.split('->').slice(1).join('->').trim();try{const t=JSON.parse(e),s='string'==typeof t?t:null;s&&n.push(`玩家欲望效果：${s}`)}catch{const t=e.replace(/^"|"$/g,'');t&&n.push(`玩家欲望效果：${t}`)}}else t&&n.push(`玩家欲望效果：${t}`)}const u=t?.battle?.core?.card_removal_count;return'string'==typeof u&&u.includes('->')&&n.push('删卡次数：'+u),n}async function I(t){await updateVariablesWith((e=>{if(!e.stat_data)throw new Error('stat_data不存在');const n=e.stat_data.reward;if(!n)throw new Error('reward数据不存在');const s=Array.isArray(n)?n[0]||{}:n,o=v(s.card),a=v(s.artifact),l=v(s.item),c=e.stat_data.battle,i=(t,e)=>{if(!e||'object'!=typeof e)return void t.push(e);const n=e.id||e.name;if(!n)return void t.push(e);const s=t.find((t=>t&&'object'==typeof t&&(t.id||t.name)===n));if(s){const t=Math.max(1,Number(e.quantity||1));s.quantity=Math.max(0,Number(s.quantity||1))+t}else null==e.quantity&&(e.quantity=1),t.push(e)},d=(t,e,n)=>{const s=(t=>{const e=c[t];return Array.isArray(e)?e.length>=2&&Array.isArray(e[0])&&'string'==typeof e[1]||e.length>=1&&Array.isArray(e[0])?e[0]:e:(console.warn(`[MVU] 目标 ${t} 不存在或非数组，跳过写入以避免破坏可扩展结构`),null)})(t);Array.isArray(s)?n.forEach((n=>{const o=e[n];null!=o&&(Array.isArray(o)?o.forEach((e=>{null!=e&&('cards'===t?i(s,e):s.push(e))})):'cards'===t?i(s,o):s.push(o))})):console.warn(`[MVU] 追加 ${t} 失败：目标不可写（不存在或非数组）`)},u={cards:[],artifacts:[],items:[]};t.cards.length&&(d('cards',o,t.cards),t.cards.forEach((t=>{const e=o[t];if(e){const t=e.name||e.id||'未知',n=e.quantity?` x${e.quantity}`:'';m.push(`新增卡牌：${t}${n}`),u.cards.push(t+n)}}))),t.artifacts.length&&(d('artifacts',a,t.artifacts),t.artifacts.forEach((t=>{const e=a[t];if(e){const t=e.name||e.id||'未知',n=e.quantity?` x${e.quantity}`:'';m.push(`新增遗物：${t}${n}`),u.artifacts.push(t+n)}}))),t.items.length&&(d('items',l,t.items),t.items.forEach((t=>{const e=l[t];if(e){const t=e.name||e.id||'未知',n=e.count?` x${e.count}`:e.quantity?` x${e.quantity}`:'';m.push(`新增道具：${t}${n}`),u.items.push(t+n)}})));try{if(u.cards.length+u.artifacts.length+u.items.length>0){const t=[];u.cards.length&&t.push(`卡牌[${u.cards.join('，')}]`),u.artifacts.length&&t.push(`遗物[${u.artifacts.join('，')}]`),u.items.length&&t.push(`道具[${u.items.join('，')}]`),r=`本轮玩家领取奖励：${t.join(' ')}`,console.log('🎯 已生成领取摘要（待绑定至选项发送）：',r)}}catch(t){console.warn('生成领取摘要失败:',t)}return s.card=[],s.artifact=[],s.item=[],s.limits={},Array.isArray(n)&&(e.stat_data.reward[0]=s),e}),{type:'message'})}function B(){const t=c||{},e=i||{};console.log('📢 渲染通知模块 - stat:',t),console.log('📢 渲染通知模块 - delta:',e),console.log('📢 渲染通知模块 - 用户操作 pills:',m);const n=t=>{t.forEach((t=>{y.includes(t)||y.push(t)}))};n(w(e)),m.length&&n(m),m=[],console.log('📢 渲染通知模块 - 最终 pills:',y);const s=i?.battle?.exp,o=i?.battle?.level;let a=!1;if('string'==typeof s&&s.includes('->')){const t=s.split('->'),e=parseInt(t[0].trim(),10),n=parseInt(t.slice(1).join('->').trim(),10);!isNaN(e)&&!isNaN(n)&&n>e&&(a=!0)}const l='string'==typeof o&&o.includes('->'),r=document.getElementById('notify-section'),d=document.getElementById('changes-section'),u=document.getElementById('exp-section'),p=document.getElementById('changes-list'),f=document.getElementById('exp-display'),g=document.getElementById('level-exp-badge');if(!(r&&d&&u&&p&&f&&g))return;if(y.length>0?(d.style.display='block',p.innerHTML=y.map((t=>`<span class="pill">${t}</span>`)).join('')):d.style.display='none',a||l){u.style.display='block';const e=[];if(a&&'string'==typeof s&&s.includes('->')){const n=s.split('->'),o=parseInt(n[0].trim(),10)||0,a=parseInt(n.slice(1).join('->').trim(),10)||0,l=Number(t?.battle?.level??1),c=Number(t?.battle?.exp??0);let i=l,r=c,d=a-o;for(;d>0&&i>1;)r>=d?(r-=d,d=0):(d-=r,i--,r=Math.max(50*i,50)-1);if(d>0){r=o,i=1;let t=r;for(;t>=50*i;)t-=50*i,i++;r=t}const u=Math.max(50*i,50),p=Math.max(50*l,50);i!==l&&e.push(`等级：LV ${i} -> LV ${l}`),e.push(`经验值：${r}/${u} -> ${c}/${p}`)}else{const n=Number(t?.battle?.level??1),s=Number(t?.battle?.exp??0),o=Math.max(50*n,50);e.push(`等级：LV ${n}`),e.push(`经验值：${s}/${o}`)}f.innerHTML=e.map((t=>`<div class="exp-item"><span class="exp-icon">✨</span><span class="exp-text">${t}</span></div>`)).join('');const n=Number(t?.battle?.level??1),o=Number(t?.battle?.exp??0);g.textContent=`Lv.${n} · EXP ${o}`,g.style.display='block'}else u.style.display='none',g.style.display='none';const h=y.length>0||a||l;r.style.display=h?'block':'none'}function k(){const t=c||{},e=E(t)||{},n=function(t){const e=E(t)||{};return{cards:e?.limits?.cards||1,artifacts:e?.limits?.artifacts||1,items:e?.limits?.items||1}}(t),s=v(e.card),o=v(e.artifact),a=v(e.item),l=document.getElementById('choice-container'),i=document.getElementById('card-rewards-section'),d=document.getElementById('artifact-rewards-section'),u=document.getElementById('item-rewards-section');if(!(l&&i&&d&&u))return;if(s.length>0){i.style.display='block';const t=document.getElementById('card-options'),e=document.getElementById('card-selection-count'),o=document.getElementById('card-selected'),a=document.getElementById('card-max');if(t&&e&&o&&a){e.textContent=`${s.length}选${n.cards}`,a.textContent=String(n.cards);const o='checkbox',l='';t.innerHTML=s.map(((t,e)=>{const n=t.cost;let s='';return'energy'===n?s='消耗: 全部能量':('number'==typeof n||null!=n)&&(s=`消耗: ${n}`),`\n        <label class="option">\n          <input type="${o}" ${l?`name="${l}"`:''} value="${e}" />\n          <span class="icon">${t.emoji||'🃏'}</span>\n          <span class="text">\n            <div class="name">${t.name||'未知'}</div>\n            ${s?`<div class="cost">${s}</div>`:''}\n            <div class="desc">${t.description||'无描述'}</div>\n          </span>\n        </label>\n      `})).join('')}}else i.style.display='none';if(o.length>0){d.style.display='block';const t=document.getElementById('artifact-options'),e=document.getElementById('artifact-selection-count'),s=document.getElementById('artifact-selected'),a=document.getElementById('artifact-max');if(t&&e&&s&&a){e.textContent=`${o.length}选${n.artifacts}`,a.textContent=String(n.artifacts);const s='checkbox',l='';t.innerHTML=o.map(((t,e)=>`\n        <label class="option">\n          <input type="${s}" ${l?`name="${l}"`:''} value="${e}" />\n          <span class="icon">${t.emoji||'💎'}</span>\n          <span class="text">\n            <div class="name">${t.name||'未知'}</div>\n            <div class="desc">${t.description||'无描述'}</div>\n          </span>\n        </label>\n      `)).join('')}}else d.style.display='none';if(a.length>0){u.style.display='block';const t=document.getElementById('item-options'),e=document.getElementById('item-selection-count'),s=document.getElementById('item-selected'),o=document.getElementById('item-max');if(t&&e&&s&&o){e.textContent=`${a.length}选${n.items}`,o.textContent=String(n.items);const s='checkbox',l='';t.innerHTML=a.map(((t,e)=>`\n        <label class="option">\n          <input type="${s}" ${l?`name="${l}"`:''} value="${e}" />\n          <span class="icon">${t.emoji||'🧪'}</span>\n          <span class="text">\n            <div class="name">${t.name||'未知'}</div>\n            <div class="desc">${t.description||'无描述'}</div>\n          </span>\n        </label>\n      `)).join('')}}else u.style.display='none';const m=s.length>0||o.length>0||a.length>0;l.style.display=m?'flex':'none',m&&function(t,e,n,s){const o={cards:[],artifacts:[],items:[]},a=(t,e)=>'cards'===t?`card-${e}`:'artifacts'===t?`artifact-${e}`:`item-${e}`;function l(l,c){const i=document.getElementById(a(l,'options')),r=document.getElementById(a(l,'selected'));i&&i.querySelectorAll('input[type="checkbox"]').forEach((a=>{a.addEventListener('change',(a=>{const d=a.target,u=parseInt(d.value),p=o[l];if(d.checked)if(1===c){if(1===p.length&&p[0]!==u){const t=p[0],e=i.querySelector(`input[type="checkbox"][value="${t}"]`);e&&(e.checked=!1),p.length=0}-1===p.indexOf(u)&&p.push(u)}else-1===p.indexOf(u)&&(p.length<c?p.push(u):d.checked=!1);else{const t=p.indexOf(u);-1!==t&&p.splice(t,1)}r&&(r.textContent=String(o[l].length)),A(o,t,e,n,s)}))}))}l('cards',s.cards),l('artifacts',s.artifacts),l('items',s.items),A(o,t,e,n,s);const c=document.getElementById('confirm-btn');if(c){const a=c.cloneNode(!0);c.parentNode?.replaceChild(a,c),a.addEventListener('click',(async()=>{if(p)return;if(t.length>0&&o.cards.length<Math.min(s.cards,t.length)||e.length>0&&o.artifacts.length<Math.min(s.artifacts,e.length)||n.length>0&&o.items.length<Math.min(s.items,n.length)){let t=document.getElementById('inline-confirm-bar');if(!t){a.style.display='none',t=document.createElement('div'),t.id='inline-confirm-bar',t.style.cssText=['margin-top:8px','padding:12px','border:1px solid #ffd666','background:#fff7e6','border-radius:8px','box-shadow:0 1px 4px rgba(0,0,0,0.06)'].join(';'),t.innerHTML='\n            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">\n              <span style="color:#ad6800;">您尚未选满所有奖励上限，是否以当前选择继续领取？</span>\n              <div style="display:flex;gap:8px;">\n                <button id="inline-confirm-yes" class="option-btn">继续领取</button>\n                <button id="inline-confirm-no" class="option-btn" style="background:#f0f0f0;color:#333;">取消</button>\n              </div>\n            </div>\n          ',a.parentElement?.appendChild(t);const e=document.getElementById('inline-confirm-yes'),n=document.getElementById('inline-confirm-no');e?.addEventListener('click',(async()=>{t.remove(),a.style.display='',await l()})),n?.addEventListener('click',(()=>{t.remove(),a.style.display=''}))}}else await l();async function l(){try{p=!0,a.disabled=!0;const s=document.getElementById('choice-container');s&&(s.style.display='none'),await I(o);try{const s=[];if(o.cards.length){const e=o.cards.map((e=>(t[e]?.name||t[e]?.id||'未知')+(t[e]?.quantity?` x${t[e]?.quantity}`:''))).filter(Boolean);e.length&&s.push(`卡牌[${e.join('，')}]`)}if(o.artifacts.length){const t=o.artifacts.map((t=>(e[t]?.name||e[t]?.id||'未知')+(e[t]?.quantity?` x${e[t]?.quantity}`:''))).filter(Boolean);t.length&&s.push(`遗物[${t.join('，')}]`)}if(o.items.length){const t=o.items.map((t=>(n[t]?.name||n[t]?.id||'未知')+(n[t]?.count?` x${n[t]?.count}`:n[t]?.quantity?` x${n[t]?.quantity}`:''))).filter(Boolean);t.length&&s.push(`道具[${t.join('，')}]`)}r=s.length?`{{user}}已获得：${s.join(' ')}`:'{{user}}没有领取奖励',console.log('✅ 已缓存本轮奖励选择摘要（将附带到下一次选项发送中）:',r)}catch(t){console.warn('插入玩家奖励选择消息失败:',t)}B(),'undefined'!=typeof toastr&&toastr.success('奖励已成功领取！','恭喜！'),setTimeout((()=>window.refreshData()),200)}catch(t){console.error('确认领取失败',t),'undefined'!=typeof toastr&&toastr.error('领取奖励失败，请重试','错误')}finally{p=!1}}}))}}(s,o,a,n)}function A(t,e,n,s,o){const a=document.getElementById('confirm-btn');a&&(a.disabled=p)}function N(t){if(p)return;console.log('🎁 渲染奖励内联 - 开始'),console.log('🎁 渲染奖励内联 - 可选奖励:',x(c));if(x(c)){t.style.display='none';const e=document.querySelector('.custom-action');e&&(e.style.display='none'),console.log('🎁 有可选奖励，隐藏选项文本和自定义行动')}else{t.style.display='';const e=document.querySelector('.custom-action');e&&(e.style.display='')}B(),k(),g();const e=document.getElementById('notify-dismiss-btn');e&&e.addEventListener('click',(()=>{const t=document.getElementById('notify-section');t&&(t.style.display='none')})),g()}function C(t){return Array.isArray(t)?t.filter((t=>'$__META_EXTENSIBLE__$'!==t&&'[]'!==t&&null!=t&&''!==t)):[]}async function L(){try{let t=null,e={};try{t=getVariables({type:'message'}),c=u(t)||{},i=t?.delta_data||t?.delta||{},e=c,console.log('🔄 加载游戏数据 - 变量:',t),console.log('🔄 加载游戏数据 - stat_data:',c),console.log('🔄 加载游戏数据 - delta_data:',i)}catch(t){return void console.warn('获取变量失败：',t)}try{await async function(){try{await updateVariablesWith((async t=>{const e=u(t)||{},n=e?.battle||t?.battle;if(!n)return t;n.core||(n.core={});let s=Number(n.level)||1,o=Number(n.exp)||0,a=0;const l=t=>Math.max(50*t,50);for(;o>=l(s);)if(o-=l(s),s+=1,a+=1,s%2==0){const t=Number(n.core.card_removal_count)||0;n.core.card_removal_count=t+1}return a>0&&(n.level=s,n.exp=o),t}),{type:'message'})}catch(t){console.warn('结算升级失败：',t)}}()}catch(t){console.warn('结算升级异常:',t)}try{t=getVariables({type:'message'}),c=u(t)||{},i=t?.delta_data||t?.delta||{},e=c,d={level:Number(c?.battle?.level??1),exp:Number(c?.battle?.exp??0)}}catch(t){console.warn('结算后重新获取变量失败：',t)}!function(t){const e=t.status||{};[{id:'status-time',path:'time'},{id:'status-location',path:'location'}].forEach((({id:t,path:n})=>{const s=document.getElementById(t);s&&(s.textContent=e?.[n]||'未知')}));const n=document.getElementById('status-job-name'),s=document.getElementById('status-job-ability');if(n||s){const t=e?.profession||{},o=t&&'object'==typeof t&&'name'in t?t.name:'',a=t&&'object'==typeof t&&'ability'in t?t.ability:'';n&&(n.textContent=o||'未知'),s&&(s.textContent=a||'未知')}const o=e.clothing||{};[{id:'clothing-head',path:'head'},{id:'clothing-neck',path:'neck'},{id:'clothing-hands',path:'hands'},{id:'clothing-top',path:'upper_body'},{id:'clothing-bottom',path:'lower_body'},{id:'clothing-underwear',path:'underwear'},{id:'clothing-legs',path:'legs'},{id:'clothing-feet',path:'feet'}].forEach((({id:t,path:e})=>{const n=document.getElementById(t);n&&(n.textContent=o?.[e]||'未穿戴')}));let a=e?.inventory||[];a=a.filter((t=>null!=t&&''!==t));const l=document.getElementById('carried-items');l&&(a.length>0?l.innerHTML=a.map((t=>`<div class="info-item"><span class="value">${t}</span></div>`)).join(''):l.innerHTML='<div class="info-item"><span class="value">无</span></div>');let c=e?.permanent_status||[],i=e?.temporary_status||[];c=c.filter((t=>null!=t&&''!==t)),i=i.filter((t=>null!=t&&''!==t));const r=document.getElementById('permanent-status');r&&(c.length>0?r.innerHTML=c.map(((t,e)=>{if('string'==typeof t)return`<span class="status-tag status-permanent">${t}</span>`;if(t&&'object'==typeof t){const n=t.name||'未知状态',s=t.description||'',o=`permanent-status-${e}`;return s?`\n                <div class="status-tag-wrapper">\n                  <span class="status-tag status-permanent clickable" onclick="toggleStatusDetail('${o}')">\n                    ${n} <span class="expand-icon">▼</span>\n                  </span>\n                  <div class="status-detail" id="${o}" style="display: none;">\n                    ${s}\n                  </div>\n                </div>\n              `:`<span class="status-tag status-permanent">${n}</span>`}return`<span class="status-tag status-permanent">${String(t)}</span>`})).join(''):r.innerHTML='<span class="status-tag status-empty">无</span>');const d=document.getElementById('temporary-status');d&&(i.length>0?d.innerHTML=i.map((t=>{if('string'==typeof t)return`<span class="status-tag status-temporary">${t}</span>`;if(t&&'object'==typeof t){return`<span class="status-tag status-temporary">${t.name||'未知状态'}</span>`}return`<span class="status-tag status-temporary">${String(t)}</span>`})).join(''):d.innerHTML='<span class="status-tag status-empty">无</span>')}(e),function(t){const e=t.battle||{},n=e.core||{},s=v(e.cards),o=v(e.artifacts),a=v(e.items),l=document.getElementById('battle-hp');if(l){const t=n?.hp||0,e=n?.max_hp||100;l.textContent=`${t}/${e}`}const c=document.getElementById('battle-desire');if(c){const t=n?.lust||0,e=n?.max_lust||100;c.textContent=`${t}/${e}`}const i=document.getElementById('battle-level');if(i){const t=e?.level||1;i.textContent=`LV ${t}`}const r=document.getElementById('battle-exp');if(r){const t=Number(e?.exp)||0,n=Number(e?.level)||1,s=Math.max(50*n,50);r.textContent=`${t}/${s}`}const d=document.getElementById('delete-count');if(d){const t=n?.card_removal_count||0;d.textContent=t.toString()}const u=document.getElementById('battle-card-remove');if(u){const t=n?.card_removal_count||0;u.textContent=t.toString()}const p=document.getElementById('battle-deck'),m=document.getElementById('battle-artifacts'),f=document.getElementById('battle-items');if(p){const t=C(s||[]);if(t.length>0){const e=t.map((t=>{return`\n          <div class="card" data-card-id="${t.id}">\n            <div class="card-delete-btn" onclick="removeCard('${t.id}')" style="display: none;">\n              🗑️\n            </div>\n            <div class="card-name">${t.emoji||'🃏'} ${t.name}</div>\n            <div class="card-cost">消耗: ${t.cost||0}</div>\n            <div class="card-type">${e=t.type||'Skill',{Attack:'攻击',Skill:'技能',Power:'能力',Event:'事件',Corrupt:'腐化'}[e]||e}</div>\n            <div class="card-quantity">数量: ${t.quantity||1}</div>\n          </div>`;var e})).join('');p.innerHTML=e}else p.innerHTML='<div class="value">牌库为空</div>'}if(m){const t=C(o);t.length>0?m.innerHTML=t.map((t=>`\n          <div class="info-item">\n            <span class="value">${t.emoji||'💎'} ${t.name}: ${t.description}</span>\n          </div>`)).join(''):m.innerHTML='<div class="value">无遗物</div>'}if(f){const t=C(a);t.length>0?f.innerHTML=t.map((t=>`\n          <div class="info-item">\n            <span class="value">${t.emoji||'🧪'} ${t.name} x${t.count||1}</span>\n            <div class="item-description">${t.description||'无描述'}</div>\n          </div>`)).join(''):f.innerHTML='<div class="value">无道具</div>'}window.battleBookData={playerStatusEffects:e.player_status_effects||[],statuses:e.statuses||[]}}(e),function(t){const e=t.npcs||{},n=document.getElementById('npc-relations');if(n){const t=Object.entries(e).filter((([t,e])=>'$meta'!==t&&e&&'object'==typeof e&&!Array.isArray(e)&&(e.name||e.NPC姓名)));t.length>0?n.innerHTML=t.map((([t,e])=>{const n=(t,e='未知')=>Array.isArray(t)&&t.length>0?t[0]:t||e,s=n(e?.name,t),o=n(e?.tracking,!1),a=n(e?.current_action,'无动作'),l=n(e?.affection,0),c=n(e?.affection_level,'未知');return`<div class="info-card">\n            <h3 class="card-title">${s}</h3>\n            <div class="info-item">\n              <span class="label">追踪状态:</span>\n              <span class="value">${o?'追踪中':'未追踪'}</span>\n              <button class="tracking-btn ${o?'tracking-on':'tracking-off'}"\n                      onclick="toggleNPCTracking('${t}', ${!o})">\n                ${o?'🔴 停止追踪':'🟢 开始追踪'}\n              </button>\n            </div>\n            ${o?`<div class="info-item">\n              <span class="label">当前行动:</span>\n              <span class="value">${a}</span>\n            </div>`:''}\n            <div class="info-item">\n              <span class="label">好感度:</span>\n              <span class="value">${l} ${c?`(${c})`:''}</span>\n            </div>\n            <div class="info-item">\n              <span class="label">阵营:</span>\n              <span class="value">${n(e?.alignment,'未知阵营')}</span>\n            </div>\n            <div class="info-item">\n              <span class="label">对主角的看法/关系:</span>\n              <span class="value">${n(e?.relationship,'未知关系')}</span>\n            </div>\n            <div class="info-item">\n              <span class="label">与其他NPC关系:</span>\n              <span class="value">${n(e?.other_npc_relations,'无')}</span>\n            </div>\n            <div class="info-item">\n              <span class="label">等级:</span>\n              <span class="value">LV ${n(e?.level,1)}</span>\n            </div>\n            <div class="info-item">\n              <span class="label">外貌描述:</span>\n              <span class="value">${n(e?.appearance,'无描述')}</span>\n            </div>\n            <div class="info-item">\n              <span class="label">能力描述:</span>\n              <span class="value">${n(e?.abilities,'无')}</span>\n            </div>\n            <div class="info-item">\n              <span class="label">战斗风格描述:</span>\n              <span class="value">${n(e?.battle_style,'无')}</span>\n            </div>\n          </div>`})).join(''):n.innerHTML='<div class="info-card"><h3>暂无NPC关系</h3></div>'}}(e),function(t){const e=t.factions||{},n=(t,e='未知')=>Array.isArray(t)&&t.length>0?t[0]:t||e,s=n(e?.player_alignment,'绝对中立'),o=e.relations||[],a=Array.isArray(o)?C(o):[];!function(t){const e=document.getElementById('alignment-grid');if(!e)return;const n=['守序善良','中立善良','混乱善良','守序中立','绝对中立','混乱中立','守序邪恶','中立邪恶','混乱邪恶'];e.innerHTML='',n.forEach((n=>{const s=document.createElement('div');s.className='alignment-cell'+(n===t?' active':''),s.textContent=n,e.appendChild(s)}))}(s);const l=document.getElementById('invasion-intensity-badge'),c=document.getElementById('invasion-intensity-row'),i=e?.invasion,r=Number(i);if(l)if(Number.isFinite(r)){l.textContent=String(r);let t='#ffffff',e='#333333';if(r<=0)t='#ffffff',e='#333333';else if(r<=5){const n=r/5;t=`rgb(${255}, ${Math.round(255*(1-n))}, ${Math.round(255*(1-n))})`,e=n>.6?'#ffffff':'#662222'}else 6===r?(t='#7a0000',e='#ffffff'):(t='#111111',e='#ffffff');c&&(c.style.backgroundColor=t,c.style.color=e,c.style.borderRadius='6px',c.style.padding='6px 10px'),l.style.backgroundColor='transparent',l.style.color=e,l.style.padding='2px 8px',l.style.borderRadius='6px',l.style.border='1px dashed var(--notebook-border)'}else l.textContent='未知',c&&(c.style.backgroundColor='transparent',c.style.color='var(--text-primary)'),l.style.backgroundColor='transparent',l.style.color='var(--text-secondary)';const d=document.getElementById('faction-relations');d&&(a.length>0?d.innerHTML=a.map((t=>{const e=n(t.name,'未知势力'),s=n(t.status,'中立'),o=n(t.reputation,0),a=n(t.note,'无');return`\n        <div class="info-card">\n          <h3>${e}</h3>\n          <div class="info-item">\n            <span class="label">状态:</span>\n            <span class="value faction-status ${s.toLowerCase()||'neutral'}">${s}</span>\n          </div>\n          <div class="info-item">\n            <span class="label">声望:</span>\n            <span class="value">${o}</span>\n          </div>\n          <div class="info-item">\n            <span class="label">备注:</span>\n            <span class="value">${a}</span>\n          </div>\n        </div>\n      `})).join(''):d.innerHTML='<div class="info-card"><h3>暂无势力关系</h3></div>')}(e),console.log('🔄 加载游戏数据 - 开始渲染选项'),function(){console.log('🚀 renderOptions() 被调用，当前发送状态:',S);const t=document.querySelector('.options-text');if(!t)return void console.log('❌ 找不到 .options-text 容器');console.log('🔄 重置发送状态从',S,'到 false'),j(!1),g();const e=t.closest('.section');e&&(e.style.display='');t.removeAttribute('data-options-rendered');let n='';const s=t.getAttribute('data-source');if(s){const t=document.getElementById(s);if(t&&t.content){const e=document.createElement('div');e.appendChild(t.content.cloneNode(!0)),n=e.innerHTML.trim(),console.log('📋 从template获取内容:',n)}}n||(n=t.innerHTML.trim(),console.log('📋 从innerHTML获取内容:',n));if(console.log('🔍 Options调试信息:',{原始长度:n.length,前100字符:n.substring(0,100),包含Option标签:n.includes('<Option'),包含BattleOption标签:n.includes('<BattleOption'),包含Options外层标签:n.includes('<Options')}),!n.includes('<Option')&&!n.includes('<BattleOption')&&!n.includes('<Options')){if(s){const t=document.getElementById(s);if(t){const e=document.createElement('div');e.appendChild(t.content.cloneNode(!0)),n=e.textContent||e.innerText||''}}n||(n=t.textContent||t.innerText||''),console.log('🔄 使用文本内容:',n)}const o=n.includes('<REWARD>');n.replace(/<REWARD>/g,'').trim();try{if(!c){const t=getVariables({type:'message'});c=u(t)||{},i=t?.delta_data||t?.delta||{}}}catch(t){console.warn('获取变量失败（奖励预处理）',t)}console.log('🔍 当前 delta_data:',i),console.log(' 当前 stat_data:',c);try{console.log('📦 完整 stat_data JSON:',JSON.stringify(c,null,2))}catch(t){console.warn('stat_data 序列化失败:',t)}t.style.display='';const a=x(c),l=w(i||{}),r=i?.battle?.exp,d=i?.battle?.level,p=l.length>0||'string'==typeof r&&r.includes('->')||'string'==typeof d&&d.includes('->');if(console.log('🔍 通知 pills:',l),console.log('🔍 经验变化:',r),console.log('🔍 等级变化:',d),console.log('🔍 有通知:',p),console.log('🎯 渲染选项 - 有可选奖励:',a),console.log('🎯 渲染选项 - 有奖励标签:',o),console.log('🎯 渲染选项 - 有通知:',p),a)return console.log('🎯 渲染选项 - 渲染奖励内联（有可选奖励）'),void N(t);(o||p)&&(console.log('🎯 渲染选项 - 渲染奖励内联（有奖励标签或通知）'),N(t));if(t.innerHTML='',!n.trim()){const e=t.closest('.section');return void(e&&(e.style.display='none',console.log('❌ 无原始内容，隐藏整个选项区域')))}let m=n;if(n.includes('<Options')){const t=n.match(/<Options[^>]*>([\s\S]*?)<\/Options>/i);t&&(m=t[1].trim(),console.log('🔧 提取Options内层内容:',m))}const f=/<(Option|BattleOption)[^>]*>([\s\S]*?)<\/\1>/g;let y,h=!1;console.log('🎯 开始匹配选项标签:',{原始内容:n,处理后内容:m,正则表达式:f.toString()});for(;null!==(y=f.exec(m));){h=!0;const e=y[1],n=y[2].trim();if(console.log('匹配到选项:',e,n),n){const s=document.createElement('button');'BattleOption'===e?(s.className='battle-option-btn',s.addEventListener('click',(()=>{console.log('🎯 标准战斗选项被点击:',n),M(n)})),console.log('创建战斗选项按钮:',n,'className:',s.className)):(s.className='option-btn',s.addEventListener('click',(()=>{console.log('🎯 标准普通选项被点击:',n),q(n)})),console.log('创建普通选项按钮:',n,'className:',s.className)),s.textContent=n,t.appendChild(s),console.log('按钮已添加到DOM，最终className:',s.className)}}if(t.setAttribute('data-options-rendered','1'),!h){console.log('没有匹配到任何选项，尝试智能解析');const e=m.split(/\r?\n/).map((t=>t.trim())).filter((t=>t&&!t.startsWith('<')&&!t.endsWith('>')));if(console.log('🔍 检测到的行数:',e.length,'内容:',e),e.length>0)e.forEach((e=>{const n=e.replace(/^\d+[.、)]?\s*/,'').trim();if(n){const e=document.createElement('button'),s=/[\u2694\u26A1]|战斗|攻击|迎击|冲击/u.test(n),o=async()=>{console.log('🎯 按行解析按钮被点击:',n),s?await M(n):await q(n)};s?(e.className='battle-option-btn',e.addEventListener('click',o),console.log('✅ 创建战斗选项按钮:',n)):(e.className='option-btn',e.addEventListener('click',o),console.log('✅ 创建普通选项按钮:',n)),e.textContent=n,t.appendChild(e),h=!0}}));else{const e=m.match(/[""][^""]+[""]|"[^"]+"/g);e&&e.length>1&&(console.log('🔍 检测到引号分割的选项:',e),e.forEach((e=>{const n=e.replace(/^[""]|[""]$/g,'').replace(/^"|"$/g,'').trim();if(n){const e=document.createElement('button');/[\u2694\u26A1]|战斗|攻击|迎击|冲击|来陪|玩玩|碾碎/u.test(n)?(e.className='battle-option-btn',e.addEventListener('click',(()=>{console.log('🎯 智能解析战斗选项被点击:',n),M(n)})),console.log('✅ 创建智能解析战斗选项:',n)):(e.className='option-btn',e.addEventListener('click',(()=>{console.log('🎯 智能解析普通选项被点击:',n),q(n)})),console.log('✅ 创建智能解析普通选项:',n)),e.textContent=n,t.appendChild(e),h=!0}})))}}const b=t.closest('.section');b&&(h?(b.style.display='',console.log('✅ 有选项，显示整个选项区域')):(b.style.display='none',console.log('❌ 无选项，隐藏整个选项区域')))}(),console.log('🔄 加载游戏数据 - 渲染选项完成'),'undefined'!=typeof requestAnimationFrame?requestAnimationFrame((()=>{setTimeout((()=>n()),50)})):setTimeout((()=>n()),100)}catch(t){console.error('加载游戏数据失败:',t)}}let S=!1;const T={_value:!1,get value(){return this._value},set value(t){console.log('📊 发送状态变化:',this._value,'->',t,'调用栈:',(new Error).stack?.split('\n')[2]?.trim()),this._value=t,S=t}};function j(t){T.value=t}async function M(t){if(S)return void console.log('⏳ 正在处理中，请稍候...');j(!0);const e=document.querySelectorAll('.option-btn, .battle-option-btn');e.forEach((t=>{t.disabled=!0,t.classList.add('disabled')})),console.log('🔥 战斗选项被点击:',t);try{const e=`用户选择了战斗选项：${t}${r?`\n\n${r}`:''}\n\n[开始战斗]`;await triggerSlash(`/send ${e}`),await triggerSlash('/trigger'),console.log('✅ 战斗触发消息已发送，等待AI生成战斗内容')}catch(t){console.error('❌ 触发战斗失败:',t),alert('触发战斗失败，请重试'),j(!1),e.forEach((t=>{t.disabled=!1,t.classList.remove('disabled')}))}finally{r=null,j(!1)}}async function q(t){if(console.log('🎯 handleOption 被调用，选项:',t,'当前发送状态:',S),S)return void console.log('⏳ 正在处理中，请稍候...（状态已被设置为true）');console.log('🔄 设置发送状态为 true'),j(!0);const e=document.querySelectorAll('.option-btn, .battle-option-btn'),n=document.getElementById('custom-action-input'),s=document.getElementById('custom-action-send');e.forEach((t=>{t.disabled=!0,t.classList.add('disabled')})),n&&(n.disabled=!0),s&&(s.disabled=!0),console.log('🎯 普通选项被点击:',t);try{const e=`用户的选择是：${t}${r?`\n\n${r}`:''}`;await triggerSlash(`/send ${e}`),await triggerSlash('/trigger')}catch(t){console.error('发送选项失败',t),alert('发送选项失败，请重试'),j(!1),e.forEach((t=>{t.disabled=!1,t.classList.remove('disabled')})),n&&(n.disabled=!1),s&&(s.disabled=!1)}finally{r=null,j(!1)}}if(window.refreshData=async function(){console.log('刷新游戏数据'),await L(),'undefined'!=typeof requestAnimationFrame?requestAnimationFrame((()=>{setTimeout((()=>n()),50)})):setTimeout((()=>n()),100)},window.checkSendingState=function(){console.log('当前发送状态:',S);const t=document.querySelectorAll('.option-btn, .battle-option-btn');return console.log('找到的按钮数量:',t.length),t.forEach(((t,e)=>{console.log(`按钮 ${e}:`,{text:t.textContent,disabled:t.disabled,className:t.className})})),S},window.resetSendingState=function(){console.log('重置发送状态，当前状态:',S),S=!1;const t=document.querySelectorAll('.option-btn, .battle-option-btn'),e=document.getElementById('custom-action-input'),n=document.getElementById('custom-action-send');t.forEach((t=>{t.disabled=!1,t.classList.remove('disabled')})),e&&(e.disabled=!1),n&&(n.disabled=!1,n.classList.remove('disabled')),console.log('发送状态已重置，所有按钮已重新启用')},window.removeCard=async function(t){try{if(!t)return void console.warn('无效的卡牌ID');await updateVariablesWith((e=>{const n=e?.stat_data?.battle||e?.battle;if(!n)throw new Error('未找到 battle 变量');const s=e=>{let n=0;return{processed:(e||[]).map((e=>{if(e&&e.id===t){const t=Number(e.quantity)||1;return t>1?(n++,{...e,quantity:t-1}):(n++,null)}return e})).filter((t=>null!==t)),removed:n}};let o=0;if(Array.isArray(n.cards))if(n.cards.length>=2&&Array.isArray(n.cards[0])&&'string'==typeof n.cards[1]){const t=s(n.cards[0]);n.cards[0]=t.processed,o+=t.removed}else if(n.cards.length>=1&&Array.isArray(n.cards[0])){const t=s(n.cards[0]);n.cards[0]=t.processed,o+=t.removed}else{const t=s(n.cards);n.cards=t.processed,o+=t.removed}n.core||(n.core={});const a=Number(n.core.card_removal_count)||0;return o>0&&(n.core.card_removal_count=Math.max(0,a-1)),e}),{type:'message'}),'undefined'!=typeof toastr&&toastr.success('已删除所选卡牌');try{await L()}catch(t){console.warn('刷新数据失败:',t)}}catch(t){console.error('删除卡牌失败:',t),'undefined'!=typeof toastr&&toastr.error('删除卡牌失败，请重试')}},window.toggleBattleBook=function(){const t=document.getElementById('battle-book-content'),e=document.querySelector('.battle-book-btn');t&&e&&('none'===t.style.display?(t.style.display='block',e.textContent='📖 隐藏状态效果',function(){const t=document.getElementById('battle-book-content');if(!t)return;const e=window.battleBookData;if(!e)return void(t.innerHTML='<div class="value">无战斗数据</div>');const n=C(e.playerStatusEffects),s=C(e.statuses);let o='';n.length>0&&(o+='<div class="battle-book-section"><h4>🔥 当前状态效果</h4>',n.forEach((t=>{o+=`\n        <div class="status-effect-item">\n          <div class="status-header">\n            <span class="status-icon">${t.emoji||'✨'}</span>\n            <span class="status-name">${t.name}</span>\n            <span class="status-stacks">${t.stacks||1}</span>\n            ${t.duration?`<span class="status-duration">(${t.duration}回合)</span>`:''}\n          </div>\n          <div class="status-description">${t.description||'无描述'}</div>\n        </div>\n      `})),o+='</div>');s.length>0&&(o+='<div class="battle-book-section"><h4>📚 状态效果图鉴</h4>',s.forEach((t=>{o+=`\n        <div class="status-effect-item">\n          <div class="status-header">\n            <span class="status-icon">${t.emoji||'✨'}</span>\n            <span class="status-name">${t.name}</span>\n            <span class="status-type ${t.type}">${'buff'===t.type?'BUFF':'DEBUFF'}</span>\n          </div>\n          <div class="status-description">${t.description||'无描述'}</div>\n          ${t.triggers?`<div class="status-triggers">触发: ${JSON.stringify(t.triggers)}</div>`:''}\n        </div>\n      `})),o+='</div>');''===o&&(o='<div class="value">暂无状态效果数据</div>');t.innerHTML=o}()):(t.style.display='none',e.textContent='📖 查看状态效果'))},window.toggleNPCTracking=async function(t,e){console.warn('[只读模式] common 页面不修改 NPC 追踪状态。')},window.gainExperience=async function(t=160){console.warn('[只读模式] common 页面不在此处直接写入经验。')},window.toggleDeleteMode=function(){const t=document.getElementById('battle-deck'),e=document.getElementById('delete-mode-toggle');if(!t||!e)return;const n=window.getVariables?.({type:'message'})||{},s=n?.stat_data?.battle||n?.battle;if((Number(s?.core?.card_removal_count)||0)<=0)return void('undefined'!=typeof toastr&&toastr.warning('删卡次数不足，无法进入删除模式'));if(t.classList.contains('delete-mode')){t.classList.remove('delete-mode'),e.style.backgroundColor='#ff6b6b';t.querySelectorAll('.card-delete-btn').forEach((t=>{t.style.display='none'}))}else{t.classList.add('delete-mode'),e.style.backgroundColor='#51cf66';t.querySelectorAll('.card-delete-btn').forEach((t=>{t.style.display='block'}))}},window.debugData=function(){try{const t=getVariables({type:'message'});if(console.log('=== 完整数据结构 ==='),console.log(t),t?.stat_data){if(console.log('=== stat_data 结构 ==='),console.log(t.stat_data),t.stat_data.status){console.log('=== 状态数据详细分析 ===');const e=t.stat_data.status;Object.keys(e).forEach((t=>{const n=e[t];console.log(`${t}:`,{type:typeof n,isArray:Array.isArray(n),value:n,length:Array.isArray(n)?n.length:'N/A'})})),console.log('=== 重点检查数组字段 ==='),console.log('持有物:',e.inventory),console.log('永久性状态:',e.permanent_status),console.log('临时状态:',e.temporary_status)}t.stat_data.battle&&(console.log('=== 战斗数据 ==='),console.log('battle.items:',t.stat_data.battle.items),console.log('battle.artifacts:',t.stat_data.battle.artifacts)),t.stat_data.npcs&&(console.log('=== NPC数据 ==='),console.log('npcs:',t.stat_data.npcs))}alert('数据结构已输出到控制台，请查看')}catch(t){console.error('调试失败:',t),alert('调试失败: '+(t?.message||'未知错误'))}},window.testVariableOperations=async function(){console.warn('[只读模式] 已禁用本页面的测试变量写入操作。')},window.switchToStory=function(){const t=document.querySelector('.tab-button[data-module="story"]');t&&t.click()},window.toggleStatusDetail=function(t){const e=document.getElementById(t);if(!e)return;const n='none'!==e.style.display;e.style.display=n?'none':'block';const s=e.closest('.status-tag-wrapper');if(s){const t=s.querySelector('.expand-icon');t&&(t.textContent=n?'▼':'▲')}},'undefined'!=typeof window){if('loading'===document.readyState){'dark'===o()&&document.documentElement.setAttribute('data-theme','dark')}const t=window,e=t.$||t.jQuery;e&&(e((()=>{console.log('RPG UI 静态模板已加载 - 使用酒馆变量宏系统'),function(){const t=o();a(t);const e=document.getElementById('theme-toggle');e&&e.addEventListener('click',l),console.log('✅ 主题系统已初始化，当前主题:',t)}(),j(!1),console.log('初始化RPG UI界面'),function(){const t=document.querySelectorAll('.tab-button'),e=document.querySelectorAll('.module-content');t.forEach((n=>{n.addEventListener('click',(function(){const n=this.getAttribute('data-module');t.forEach((t=>t.classList.remove('active'))),e.forEach((t=>t.style.display='none')),this.classList.add('active');const s=document.getElementById(n+'-content');s&&(s.style.display='block')}))}))}(),L().then((()=>console.log('✅ Common模块完全初始化完成')))})),e(t).on('pagehide',(()=>{console.log('🧹 页面卸载：清理临时状态')})))}</script></body></html>