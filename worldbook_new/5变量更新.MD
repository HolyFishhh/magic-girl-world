```
<%_ setLocalVar('initialized_lorebooks.-SnowYuki[0]', true); _%>
【变量更新】
在所有文本的最后，进行变量更新。
以下是故事中需要追踪的关键变量，当前状态以这些变量的值为准。
<status_current_variables>
状态栏：
   当前时间：{{get_message_variable::stat_data.status.time}}
   地点天气：{{get_message_variable::stat_data.status.location_weather}}
   职业：{{get_message_variable::stat_data.status.profession}}
   永久性状态：{{get_message_variable::stat_data.status.permanent_status}}
   临时状态：{{get_message_variable::stat_data.status.temporary_status}}
   服装：{{get_message_variable::stat_data.status.clothing}}
   持有物：{{get_message_variable::stat_data.status.inventory}}

战斗数据：
   核心属性（core）：
      生命值：{{get_message_variable::stat_data.battle.core.hp}}
      最大生命值：{{get_message_variable::stat_data.battle.core.max_hp}}
      欲望值：{{get_message_variable::stat_data.battle.core.lust}}
      最大欲望值：{{get_message_variable::stat_data.battle.core.max_lust}}
   卡牌：{{get_message_variable::stat_data.battle.cards}}
   遗物：{{get_message_variable::stat_data.battle.artifacts}}
   道具：{{get_message_variable::stat_data.battle.items}}
   状态定义：{{get_message_variable::stat_data.battle.statuses}}
   等级：{{get_message_variable::stat_data.battle.level}}
   经验值：{{get_message_variable::stat_data.battle.exp}}
   玩家欲望效果：{{get_message_variable::stat_data.battle.player_lust_effect}}

势力关系：
   玩家阵营：{{get_message_variable::stat_data.factions.player_alignment}}
   势力关系：{{get_message_variable::stat_data.factions.relations}}

NPC信息：{{get_message_variable::stat_data.npcs}}
</status_current_variables>
严格按照以下规则和格式进行输出，并确定每一个变量是否需要更新，不要遗漏：
rule:
  description:
    - You should output the update analysis in the end of the next response, following the variables list defined in <status_current_variables> section which will be provided by the previous turn.
    - In context, variable updates are omitted by the system so they are not shown to you, but you should still add it.
    - There are 4 commands can be used to adjust the data: `_.set`, `_.assign`, `_.remove` and `_.add`.
    - to set a certain value, use `_.set`, it supports 2 or 3 input args.
    - to insert something into an array or object, use `_.assign`, it supports 2 or 3 input args.
    - to delete something from an object/array, use `_.remove`, it supports 1 or 2 input args.
    - If you need to assign or remove multiple values, use `_.assign` or `_.remove` multiple times, not in a single command.
    - to add a delta to a number, use `_.add`, it only supports 2 input args, and only supports modifications to numbers.
    - It is allowed to use math expressions for number inputs.
  analysis:
    - You must rethink what variables are defined in the previous <status_current_variables> property, and analyze how to update each of them accordingly.
    - For counting variables, change it when the corresponding event occur but don't change it any more during the same event.
    - When a numerical variable changes, check if it crosses any stage threshold and update to the corresponding stage.
    - If dest element is in an array with description, **PRECISELY** locate the element by adding "[0]" suffix. DO NOT change the description.
    - When using _.assign to register new content, the {key_or_index} variable is not required. Including it will cause an error—register directly instead. 
    - When you need to delete a specific element from an array or dictionary, use` _.remove`. However, when you need to clear all contents of an array or dictionary, use` _.set(path, [])` or `_.set(path, {}) `instead.
    - When using _.remove for deletion, if multiple items need to be removed, call it multiple times rather than attempting to delete all variables in a single call, as that syntax is not supported.
  format: |-
    <UpdateVariable>
      <Analysis>$(IN ENGLISH$)
        - Analyze the events of the turn.
        - `status.time`: Update based on narrative time progression. Use `_.set`.
        - `status.location_weather`: Update if the character changes location or the environment changes. Use `_.set`.
        - `status.permanent_status`: When the storyline explicitly adds long-term permanent states or changes to the player. Use `_.assign` to register or `_.remove` to delete.
        - `status.temporary_status`: When short-term states appear in the storyline, update them accordingly, such as “in heat” or “afraid.” Use `_.assign` to register or `_.remove` to delete.
        - `status.clothing`: Update if clothing is added, removed, or damaged. `cloth` contains multiple subfields, each entry should be updated individually. Use `_.set`.
        - `status.inventory`: Update when items are acquired, used, or lost. Use `_.assign` to register or `_.remove` to delete.
        - `battle.core`: Adjust hp/max_hp/lust/max_lust based on damage, healing, or erotic events. Use `_.set`.  max_hp/max_lust should only change when the storyline explicitly demands such a change.  hp/lust, however, fluctuate frequently with the narrative. Under normal conditions, after each action, **hp tends to increase** while **lust tends to decrease** (hp being closer to full means healthier, lust being closer to 0 means more normal).  During rest, 8 hours of rest fully restores both hp and lust.  In other cases, 24 hours are required to fully restore both hp and lust — use this timeframe as a baseline for state recovery during the storyline.  If the story involves ongoing conditions such as injury or arousal that prevent recovery or worsen the state, reduce or maintain hp/lust accordingly based on the narrative.
        - `battle.cards/artifacts/items`:Add according to the storyline. If the user message contains “已获得：...”, it means these contents have already been successfully registered into the variables — you must never register them again. Use `_.assign` to register or `_.remove` to delete.
        - `battle.statuses`: Define any custom statuses introduced by the initial cards/artifacts/effects. This field must be populated if other effects rely on custom statuses.Use `_.assign` to register.
        - `battle.exp`: Add experience points after combat or completing objectives. Use `_.add`.
        - `factions.relations`: Modify reputation based on actions affecting a faction.
        - `npcs`: Update affection, relationship, or other details for any involved NPCs.  Registered NPCs must be important characters with explicit names — do not register ordinary enemies, mobs, or passersby.  Multiple cases exist, such as registering new NPCs, deleting NPCs that no longer appear, or modifying existing NPCs.  Flexibly use various syntax options.
      </Analysis>
      _.set('${path}', ${old}?, ${new});        //${reason}
      _.assign('${path}', ${key_or_index}?, ${value});        //${reason}
      _.remove('${path}', ${key_or_index_or_value}?);        //${reason}
      _.add('${path}', ${delta});        //${reason}
    </UpdateVariable>
    example: |-
    <UpdateVariable>
      <Analysis>
        The character finished a conversation with NPC "Elara" where they were kind, then traveled from the "Sunstone Plaza" to the "Whispering Tavern". The journey took about 20 minutes.
        - `status.time`: Advanced by 20 minutes.
        - `status.location_weather`: Changed to the tavern.
        - `npcs.elara.affection`: Increased due to the kind conversation.
      </Analysis>
      _.set('status.time', '7月18日, 周五, 傍晚, 16:35', '7月18日, 周五, 傍晚, 16:55');        // Time passes during travel.
      _.set('status.location_weather', '阳石广场 - 晴朗', '低语酒馆 - 昏暗温暖');        // Character moved to a new location.
      _.add('npcs.elara.affection', 5);        // Positive interaction with Elara.
    </UpdateVariable>
```