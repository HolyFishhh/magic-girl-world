# 战斗相关内容生成要求
首先明确战斗游戏模式
本游戏，是仅存在1v1的，单机卡牌对战游戏，敌人的数据被简化，没有具体的卡牌，能量等效果。只有玩家可以打出卡牌，消耗能量，进行游戏。
## 字段补充说明
具体的字段结构与简单描述已在“## 变量说明”部分说明，本部分为对具体的内容的详细和补充说明
### type
- `Attack`: 攻击牌，主要用于直接造成伤害，欲望伤害，可以附加额外的效果，例如buff等。
- `Skill`: 技能牌，用于获得格挡、抽卡、增益等不直接造成伤害的卡牌（可以间接造成伤害）。
- `Power`: 能力牌，提供持续整场战斗的能力，触发的能力必须要有触发条件前缀。能力牌一般都会带有`retain`，打出后消耗，防止重复使用，导致单张卡过于强大。
- `Event`: 事件牌，用于触发特殊的叙事或非战斗效果，必须搭配`narrate`字段，也可以需要特殊条件才能触发。使用后，会直接结束战斗，触发剧情。根据具体的剧情需要适当生成。
- `Curse`: 诅咒牌，无法被打出（无 `cost` 字段），effect的触发条件和普通牌不同，会在回合结束时检测，如果手牌中有该类型的牌，会触发对应的effect。一般带有`ethereal`，来防止一直无法移除。特定情况可以无视该要求。
### rarity
- `Common`: 普通的卡牌，往往只有一个单独且直接的基础效果，例如造成伤害/欲望伤害,获得格挡
- `Uncommon`: 稀有的卡牌，除基础的效果的值更高外，还可以附加额外的效果，例如造成伤害，附件负面buff。在本稀有度，允许出现抽牌，增加buff，弃牌等基础的效果
- `Rare`: 罕见卡牌，可以造成较为复杂的效果，允许组合1-3个效果，并可以造成更高的基础效果。本稀有度允许出现不强力的能力牌，并支持所有的词条。但是效果不能过强。
- `Epic`: 史诗卡牌，可以支持任何类型，必须拥有较为强大或较为复杂的效果。但是其程度不能直接让游戏胜利。仅提供较大的优势。
- `Legendary`: 传说卡牌，可以支持任何类型，非常强大，可以彻底改变玩家的游戏思路，或取得巨大的游戏优势。
- `Corrupt`: 堕落卡牌，由负面事件或敌人注入。一般为`Curse`类型的牌，也可以是其他类型的牌，但是主要效果是负面的，也可以造成正面的效果，但是一定要有比正面效果更大的负面代价
### cost
- 打出卡牌所需消耗的费用，玩家初始能量上限为3，所以一般cost为0-3之间，当玩家没有增加费用的手段时，不要出现大于最大费用的，打不出的牌
- 可以使用`energy`代表cost，此时打出卡牌会消耗掉当前所有的能量（为0时也可以打出）,并且这种卡牌基本上都会有按当前的能量触发n次效果的逻辑
### effect/discard_effect
- 卡牌效果的主要字段，必须严格按通用效果解析公式来编写
- `effect`代表普通打出时的效果，必填
- `discard_effect`代表当该手牌被非系统（每回合结束的弃牌）弃掉时，会触发的效果，非必填，仅当玩家或敌人拥有弃牌相关能力时，生成的卡牌可以带有该效果
### retain/exhaust/ethereal
- 该部分的参数，涉及到卡牌的特殊效果，使用bool值表示，均为可选，需要时再生成对应的key即可。默认为false
- `retain`：保留，此字段为true的卡牌，不会在每回合结束时被系统丢弃
- `exhaust`：消耗，此字段为true的卡牌，会在打出后移除抽牌循环，不会再被抽到。（一般能力卡，或效果极为强力的卡通过此字段限制强度）
- `ethereal`：空灵，此字段为true的卡牌，回合结束时扔留在手牌中，则会被消耗（一般诅咒卡使用，防止诅咒卡占用过多手牌）
## 设计原则
- `description` 必须准确地反映 `effect` 的内容。
- 如果要使用新的状态（buff/debuff），必须注册对应的buff变量
- 在生成卡牌时，要综合分析玩家现有卡组，设计出具有联动感的卡组或根据剧情设计，不要设计完全无关的卡组
## 通用效果解析公式
### 公式构成元素
示例：
- 基础公式：`目标.属性或效果 操作符 值`
`ME.hp + 5` - 我方生命值+5
`OP.lust - 3` - 对方欲望值-3
`ALL.hp - 5` - 双方各减少5点生命值

- buff操作：`对象.status 操作符 buffid 层数`
`OP.status apply buffid 3` - 对方获得3层buffid对应的状态
`ME.status remove buffid` - 我方移除buffid对应的状态

- 带有选择器的效果：`需要选择器的效果.域.关键字`
`reduce_cost.hand.choose2 1` - 选择两张手牌，费用减1
`copy_card.draw.random` - 复制随机一张抽牌堆的牌到手牌
`reduce_cost.discard.all 1` - 所有弃牌堆的牌费用减1

- 能力（触发器）：`目标.触发条件(效果1, 效果2, ...)`  #支持多个效果
`ME.battle_start(OP.status apply buffid 1)` - 我方能力，战斗开始时，为对方添加一层对应buff

- 复合效果示例
`ME.hp + 5, OP.lust - 3, discard.random` - 我方回血5点，对方欲望-3，随机弃1张牌
`ME.turn_start(ME.energy + 1), OP.status apply buff 2` - 我方获得回合开始能量+1的能力，对方获得buff2层
`OP.hp - ME.stacks.strength * 3` - 对方受到伤害等于我方力量buff层数的3倍

同一张卡片的多个效果，使用`,` 作为唯一分隔符
触发器后的内容如果需要多个效果，使用`()`包裹，代表该触发器触发的所有效果

#### 目标（必须）
- `ME` - 我方（使用者自己）
- `OP` - 对方（使用者的敌对目标）
- `ALL` - 双方（同时作用于敌我双方）
需根据使用者灵活区分，当触发效果（能力，欲望效果，意图，buff）者为敌人时,ME代表敌人，OP代表玩家
当触发效果者（卡牌，遗物，能力，欲望效果，buff...）为玩家时,ME代表玩家，OP代表敌人
但注意，有些属性是默认作用于玩家的，此时可以不使用目标，因为只会影响到玩家

示例：
敌人对玩家造成效果，那么敌人的卡牌effect中对应的目标为OP
敌人对自己造成效果，对应字段为ME
玩家对敌人造成效果，对应字段为OP
玩家对自己造成效果，对应字段为ME
对双方同时造成效果，使用ALL目标

#### 属性
基础属性（敌我双方均可）：
- `hp` - 生命值
- `lust` - 欲望值
- `block` - 格挡
- `max_hp` - 最大生命值
- `max_lust` - 最大欲望值
- `status` - 状态效果


玩家独有属性（无需前缀，无论敌我使用，都自动作用于玩家）
- `energy` - 能量
- `max_energy` - 最大能量
- `draw` - 抽牌（+1代表抽一张牌,-1代表下回合少抽一张牌）


#### 效果
和属性处于相同的位置，不同的是实现更复杂

以下内容均不需要指定目标，都会默认作用于玩家
效果：
- `narrate` - 叙事（Event类型卡牌，敌我双方都可触发）
- `add_to_hand/add_to_deck` - 插入一张卡到手牌/牌库
需搭配选择器指定卡牌
- `discard` - 弃牌操作
- `reduce_cost` - 减少卡牌费用
- `copy_card` - 复制卡牌
- `trigger_effect` - 触发卡牌效果
- `exile` - 消耗卡牌
- `stun` - 无法行动

##### narrate
格式：`narrate "具体的触发叙事内容"`
注意，一但使用narrate，游戏将会强制中止，开始AIRP，建议在特殊卡牌，欲望效果，特殊敌人上使用
生产时务必保证严谨，尽量不要在敌人的随机行为中生成，一般在敌人顺序行为的末尾，敌人的欲望效果，敌人给玩家添加的卡牌中生成
叙事的角度为{{user}}第一视角或上帝视角

##### add_to_hand/add_to_deck
格式：`add_to_hand/add_to_deck {完整的json格式卡牌字符串}`
示例：
`add_to_deck {\"id\":\"flame_strike\",\"name\":\"烈焰打击\",\"emoji\":\"🔥\",\"type\":\"Attack\",\"cost\":2,\"effect\":\"OP.hp - 15\",\"description\":\"造成15点火焰伤害\"}` - 在抽牌堆插入烈焰打击
`add_to_hand {\"id\":\"card_a\",\"name\":\"卡牌A\",\"emoji\":\"🎴\",\"type\":\"Skill\",\"cost\":1,\"effect\":\"add_to_hand {\\\"id\\\":\\\"card_b\\\",\\\"name\\\":\\\"卡牌B\\\",\\\"emoji\\\":\\\"🃏\\\",\\\"type\\\":\\\"Attack\\\",\\\"cost\\\":2,\\\"effect\\\":\\\"OP.hp - 20\\\"}\",\"description\":\"生成卡牌B\"}` - 多级嵌套，插入可以生成卡牌B的卡牌A
需注意，最好将插入的卡牌带上消耗字段，防止牌库无限扩大
增加的卡牌会在战斗结束后清除，不保留

##### stun
格式：ME/OP.stun
敌我双方均可用，必须在buff的hold字段中使用，不能单独使用，持续时间同buff，生成相关字段时必须严谨，避免出现敌方/我方一直无法行动的情况

#### 操作符号
- `+` - 增加
- `-` - 减少
- `*` - 乘以
- `/` - 除以
- `=` - 设置为
- `apply` - 施加（用于状态效果）
- `remove` - 移除（用于状态效果）

#### 操作值与变量
操作值支持直接的数字，或根据战斗动态变化的变量

共有变量（需前缀，指明变量获取的对象）：
- `hp`  - 当前生命值
- `max_hp` - 最大生命值
- `lust` - 当前欲望值
- `max_lust` - 最大欲望值
- `block` - 当前格挡值
- `stacks` - 层数，在buff/debuff的effect中使用时，对应当前状态的层数，在非buff的触发条件中使用时，需要指向目标和buffid


玩家独有变量（默认取玩家的）：
- `energy` - 当前能量
- `max_energy` - 最大能量
- `hand_size` - 当前手牌数量
- `deck_size` - 抽牌堆数量
- `discard_pile_size` - 弃牌堆数量
- `cards_played_this_turn` - 本回合已出牌数

当为apply或remove时，值的组成格式为： buff值 层数
buff值有
- `buffid` - 对应具体的buffid，指定一个唯一的buff
- `all_buffs` - 所有状态（正面+负面），仅用于remove和stacks引用
- `buffs` - 所有正面buff，仅用于remove和stacks引用
- `debuffs` - 所有负面buff，仅用于remove和stacks引用

##### stacks二次指向：
除了在buff内部直接使用`stacks`外，支持通过二次指向语法获取指定buff的层数：
- `ME.stacks.buffid` - 我方指定buff的层数
- `OP.stacks.buffid` - 对方指定buff的层数
- `ALL.stacks.buffid` - 双方指定buff的层数总和
- `ME.stacks.all_buffs` - 我方所有状态（正面+负面）的层数总和
- `ME.stacks.buffs` - 我方所有正面buff的层数总和
- `ME.stacks.debuffs` - 我方所有负面buff的层数总和

示例：
- `ME.hp + OP.stacks.poison` - 我方生命值增加等于对方毒性buff的层数
- `OP.hp - ME.stacks.buffs * 2` - 对方受到伤害等于我方所有正面buff层数总和的2倍
- `ME.block + ALL.stacks.all_buffs` - 我方格挡增加等于双方所有状态层数的总和
- `OP.status remove all_buffs` - 移除对方所有状态
- `OP.status remove buffs` - 仅移除对方所有正面buff
- `OP.status remove debuffs` - 仅移除对方所有负面buff

#### 能力与触发器
触发器字段，是当达成特定条件后，实现对应效果的字段。仅有能力，能力卡或遗物可以使用触发器。一但获得能力，就会持续直到战斗结束
在生成能力卡牌时需要注意，能力避免重复触发，基本上所有的能力牌都应该是打出后会消耗的，即exhaust
可不指定目标，此时默认为己方添加能力
请注意，禁止嵌套，即能力的效果是添加能力，不允许这样的字段。

触发条件：
- `battle_start` - 战斗开始时（仅在遗物和初始化时可用，仅触发一次，不能运用在卡牌，欲望效果之上，因为进入战斗后就没有战斗开始环节了）
- `ability_gain` - 获得能力时（仅触发一次）
- `turn_start` - 回合开始时
- `turn_end` - 回合结束时
- `card_played` - 打出卡牌时
- `on_discard` - 弃掉卡牌时
- `passive` - 被动效果（一般用于修饰符）
伤害相关触发条件：
- `take_damage` - 受到伤害时
- `take_heal` - 受到治疗时
- `deal_damage` - 造成伤害时
- `deal_heal` - 造成治疗时
- `lust_increase` - 欲望增加时
- `lust_decrease` - 欲望减少时
- `deal_lust_increase` - 造成欲望增加时
- `deal_lust_decrease` - 造成欲望减少时
格挡相关触发条件：
- `gain_block` - 获得格挡时
- `lose_block` - 失去格挡时
状态效果相关触发条件：
- `gain_buff` - 获得增益时
- `gain_debuff` - 获得减益时
- `lose_buff` - 失去增益时
- `lose_debuff` - 失去减益时
- `enemy_gain_buff` - 敌人获得增益时
- `enemy_gain_debuff` - 敌人获得减益时
- `enemy_lose_buff` - 敌人失去增益时
- `enemy_lose_debuff` - 敌人失去减益时

#### 状态（buff/debuff）
游戏没有预的状态设，完全动态创建。当你在效果中使用新的状态ID时，必须在变量中定义该状态的详细信息。否则会导致卡牌无效。
需要在变量的`battle.statuses`数组中添加状态定义。
状态的目标是根据持有者判断的，默认作用于持有状态的实体，OP代表持有状态实体的敌人。
重要：状态的triggers的子字段中必须使用统一效果表达式语法，来表示对应情况下触发的effect，允许有多个triggers。
triggers的子字段，统一语法，可以使用`stacks`，来代指当前buff的层数，实现动态计算效果。
triggers的子字段不可扩展，仅有固定的内容，不能混用触发条件，如果需要注册触发条件，使用hold的triggers，在其中注册能力

##### 状态持续与衰减
- 没有“持续回合”设定，状态仅有“层数（stacks）”。持续的时间根据衰减机制决定。
- 支持“衰减/变化”机制：在状态定义里通过 `stacks_change` 指定每回合层数变化：
  - 纯数值：如 `-1` 每回合-1层，`+2` 每回合+2层
  - 百分比：如 `x0.5` 每回合层数减半（向下取整）
  - 特殊：`reset` 每回合清零；`keep` 不变

#### 修饰符
修饰符通过buff/debuff的hold条件或触发条件为passive的能力来使用
修饰符的效果为，让特定数值的直接效果的数值，额外设置`增减乘除等`的计算
修饰符系统支持加法(+)、减法(-)、乘法(*)、除法(/)和设置(=)操作。
修饰符列表:
- `damage_modifier` - 伤害修饰符（影响造成的伤害）
- `damage_taken_modifier` - 受到伤害修饰符（影响受到的伤害）
- `lust_damage_modifier` - 欲望伤害修饰符（影响造成的欲望伤害）
- `lust_damage_taken_modifier` - 受到欲望伤害修饰符（影响受到的欲望伤害）
- `block_modifier` - 格挡修饰符（影响获得的格挡值）

示例：
- `passive(ME.damage_modifier * 2)` - 能力，造成的伤害额外增加为2倍
- `block_modifier + stacks * 3` - buff，防御值额外增加buff层数的三倍

修饰符计算顺序：
加法和减法修饰符直接累加
乘法和除法修饰符按顺序应用到当前值
设置修饰符强行会覆盖当前值

#### 选择器
- 域：
  - `hand.`（手牌）
  - `draw.`（抽牌堆）
  - `discard.`（弃牌堆）
- 关键字：
  - `random` - 随机选择（可用数字后缀，如 `random2`，代指随机两张）
  - `choose` - 玩家主动选择
  - `leftmost`/`rightmost` - 最左侧/最右侧（仅 hand.* 支持）
  以上关键字可跟数字，代表作用的卡牌数，例如`random2`指随机两张
  - `all` - 当前域所有卡牌
  - `all_cards` - 全部卡牌（手牌 + 抽牌堆 + 弃牌堆，无需前缀）
- 组合：用 `+` 连接多个选择器（如 `hand.random+discard.random2`）
- 注意：抽牌堆与弃牌堆没有左右顺序的概念，不支持 leftmost/rightmost 系列。

#### 条件判断语法
支持if-else条件判断，格式为：`if[条件][真效果]else[假效果]` 或 `if[条件][效果]`

**重要：**使用中括号`[]`来区分条件判断和触发条件

**条件运算符：**
- `>` - 大于
- `<` - 小于
- `>=` - 大于等于
- `<=` - 小于等于
- `==` - 等于
- `!=` - 不等于

**示例：**
- `if[ME.energy > 2][OP.hp - 15]else[OP.hp - 8]` - 如果能量大于2造成15伤害，否则造成8伤害
- `if[ME.hp < ME.max_hp / 2][ME.block + 10, draw + 1]` - 血量低于一半时获得格挡和抽牌
- `if[OP.stacks.poison > 5][OP.hp - OP.stacks.poison * 2]` - 如果对方毒性层数大于5，造成毒性层数2倍的伤害
- `if[ALL.stacks.burn >= 10][ALL.hp - 20]` - 如果双方燃烧层数总和大于等于10，双方各受到20点伤害

#### 遗物
对应变量`battle.artifacts`
遗物是提供持续战斗效果的物品，持续整场战斗,效果同能力，不同的是，能力会在战斗结束后清除，遗物下次战斗也会存在，不会再战斗中增加，只能通过触发剧情来变动。
effect使用通用效果解析公式，必须包含触发器

#### 道具
对应变量`battle.items`
道具仅玩家可以使用，且使用后必定消耗（count-1）
effect使用通用效果解析公式

## 重要规则
- 生成带有buff/debuff的卡牌，必须先检测battle.statuses中是否有对应的定义，没有则一定要生成新的定义